(()=>{"use strict";const c=window.crypto||window.msCrypto;const s=window.localStorage;const l="hexo-blog-encrypt:#"+window.location.pathname;const t=o("hexo-blog-encrypt的作者们都是大帅比!");const n=o("hexo-blog-encrypt是地表最强Hexo加密插件!");const d="<hbe-prefix></hbe-prefix>";const r=document.getElementById("hexo-blog-encrypt");const a=r.dataset["wpm"];const i=r.dataset["whm"];const e=r.getElementsByTagName("script")["hbeData"];const u=e.innerText;const y=e.dataset["hmacdigest"];function f(e){return new Uint8Array(e.match(/[\da-f]{2}/gi).map(e=>{return parseInt(e,16)}))}function o(e){var t=e.length;var n=0;var o=new Array;for(var r=0;r<t;){var a=e.codePointAt(r);if(a<128){o[n++]=a;r++}else if(a>127&&a<2048){o[n++]=a>>6|192;o[n++]=a&63|128;r++}else if(a>2047&&a<65536){o[n++]=a>>12|224;o[n++]=a>>6&63|128;o[n++]=a&63|128;r++}else{o[n++]=a>>18|240;o[n++]=a>>12&63|128;o[n++]=a>>6&63|128;o[n++]=a&63|128;r+=2}}return new Uint8Array(o)}function h(e){if(typeof e!=="object"||e===null||typeof e.byteLength!=="number"){throw new TypeError("Expected input to be an ArrayBuffer")}var t=new Uint8Array(e);var n="";var o;for(var r=0;r<t.length;r++){o=t[r].toString(16);n+=o.length===1?"0"+o:o}return n}async function m(t){let n=document.createElement("script");const e=["type","text","src","crossorigin","defer","referrerpolicy"];e.forEach(e=>{if(t[e])n[e]=t[e]});return n}async function g(e){let t=document.createElement("div");t.innerHTML=e;t.querySelectorAll("script").forEach(async e=>{e.replaceWith(await m(e))});return t}function p(e){let t=new TextEncoder;return c.subtle.importKey("raw",t.encode(e),{name:"PBKDF2"},false,["deriveKey","deriveBits"])}function w(e){return c.subtle.deriveKey({name:"PBKDF2",hash:"SHA-256",salt:t.buffer,iterations:1024},e,{name:"HMAC",hash:"SHA-256",length:256},true,["verify"])}function b(e){return c.subtle.deriveKey({name:"PBKDF2",hash:"SHA-256",salt:t.buffer,iterations:1024},e,{name:"AES-CBC",length:256},true,["decrypt"])}function v(e){return c.subtle.deriveBits({name:"PBKDF2",hash:"SHA-256",salt:n.buffer,iterations:512},e,16*8)}async function E(e,t){const n=new TextEncoder;const o=n.encode(t);let r=f(y);const a=await c.subtle.verify({name:"HMAC",hash:"SHA-256"},e,r,o);console.log(`Verification result: ${a}`);if(!a){alert(i);console.log(`${i}, got `,r,` but proved wrong.`)}return a}async function x(e,t,i){let n=f(u);const o=await c.subtle.decrypt({name:"AES-CBC",iv:t},e,n.buffer).then(async e=>{const t=new TextDecoder;const n=t.decode(e);if(!n.startsWith(d)){throw"Decode successfully but not start with KnownPrefix."}const o=document.createElement("button");o.textContent="Encrypt again";o.type="button";o.classList.add("hbe-button");o.addEventListener("click",()=>{window.localStorage.removeItem(l);window.location.reload()});document.getElementById("hexo-blog-encrypt").style.display="inline";document.getElementById("hexo-blog-encrypt").innerHTML="";document.getElementById("hexo-blog-encrypt").appendChild(await g(n));document.getElementById("hexo-blog-encrypt").appendChild(o);document.querySelectorAll("img").forEach(e=>{if(e.getAttribute("data-src")&&!e.src){e.src=e.getAttribute("data-src")}});window.NexT&&NexT.boot&&typeof NexT.boot.refresh==="function"&&NexT.boot.refresh();var r=document.getElementById("toc-div");if(r){r.style.display="inline"}var a=document.getElementsByClassName("toc-div-class");if(a&&a.length>0){for(var c=0;c<a.length;c++){a[c].style.display="inline"}}var s=new Event("hexo-blog-decrypt");window.dispatchEvent(s);return await E(i,n)}).catch(e=>{alert(a);console.log(e);return false});return o}function A(){const e=JSON.parse(s.getItem(l));if(e){console.log(`Password got from localStorage(${l}): `,e);const n=f(e.iv).buffer;const t=e.dk;const o=e.hmk;c.subtle.importKey("jwk",t,{name:"AES-CBC",length:256},true,["decrypt"]).then(t=>{c.subtle.importKey("jwk",o,{name:"HMAC",hash:"SHA-256",length:256},true,["verify"]).then(e=>{x(t,n,e).then(e=>{if(!e){s.removeItem(l)}})})})}r.addEventListener("keydown",async e=>{if(e.isComposing||e.key==="Enter"){const t=document.getElementById("hbePass").value;const n=await p(t);const o=await w(n);const r=await b(n);const a=await v(n);x(r,a,o).then(e=>{console.log(`Decrypt result: ${e}`);if(e){c.subtle.exportKey("jwk",r).then(n=>{c.subtle.exportKey("jwk",o).then(e=>{const t={dk:n,iv:h(a),hmk:e};s.setItem(l,JSON.stringify(t))})})}})}})}A()})();