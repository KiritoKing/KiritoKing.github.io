<!DOCTYPE html><html lang="zh-CN,default"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="keywords" content="Hexo Theme Redefine"><meta name="author" content="ChlorineC"><link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="canonical" href="https://kiritoking.github.io/posts/2808426581/"><meta name="robots" content="index,follow"><meta name="googlebot" content="index,follow"><meta name="revisit-after" content="1 days"><meta name="description" content="WebSocket æ˜¯åŸºäº TCP çš„ä¸€ç§æ–°çš„åº”ç”¨å±‚ç½‘ç»œåè®®ã€‚å®ƒå®ç°äº†æµè§ˆå™¨ä¸æœåŠ¡å™¨å…¨åŒå·¥é€šä¿¡ï¼Œå³å…è®¸æœåŠ¡å™¨ä¸»åŠ¨å‘é€ä¿¡æ¯ç»™å®¢æˆ·ç«¯ã€‚å› æ­¤ï¼Œåœ¨ WebSocket ä¸­ï¼Œæµè§ˆå™¨å’ŒæœåŠ¡å™¨åªéœ€è¦å®Œæˆä¸€æ¬¡æ¡æ‰‹ï¼Œä¸¤è€…ä¹‹é—´å°±ç›´æ¥å¯ä»¥åˆ›å»ºæŒä¹…æ€§çš„è¿æ¥ï¼Œå¹¶è¿›è¡ŒåŒå‘æ•°æ®ä¼ è¾“ï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´çš„æ•°æ®äº¤æ¢å˜å¾—æ›´åŠ ç®€å•ã€‚"><meta property="og:type" content="article"><meta property="og:title" content="WebSocket åº”ç”¨ç ”ç©¶"><meta property="og:url" content="https://kiritoking.github.io/posts/2808426581/index.html"><meta property="og:site_name" content="Top-Down Web Techs"><meta property="og:description" content="WebSocket æ˜¯åŸºäº TCP çš„ä¸€ç§æ–°çš„åº”ç”¨å±‚ç½‘ç»œåè®®ã€‚å®ƒå®ç°äº†æµè§ˆå™¨ä¸æœåŠ¡å™¨å…¨åŒå·¥é€šä¿¡ï¼Œå³å…è®¸æœåŠ¡å™¨ä¸»åŠ¨å‘é€ä¿¡æ¯ç»™å®¢æˆ·ç«¯ã€‚å› æ­¤ï¼Œåœ¨ WebSocket ä¸­ï¼Œæµè§ˆå™¨å’ŒæœåŠ¡å™¨åªéœ€è¦å®Œæˆä¸€æ¬¡æ¡æ‰‹ï¼Œä¸¤è€…ä¹‹é—´å°±ç›´æ¥å¯ä»¥åˆ›å»ºæŒä¹…æ€§çš„è¿æ¥ï¼Œå¹¶è¿›è¡ŒåŒå‘æ•°æ®ä¼ è¾“ï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´çš„æ•°æ®äº¤æ¢å˜å¾—æ›´åŠ ç®€å•ã€‚"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://picgo-1308055782.cos.ap-chengdu.myqcloud.com/picgo-core/2023/07/20230709002811.png"><meta property="og:image" content="https://picgo-1308055782.cos.ap-chengdu.myqcloud.com/picgo-core/2023/07/20230709002816.png"><meta property="og:image" content="https://picgo-1308055782.cos.ap-chengdu.myqcloud.com/picgo-core/2023/07/20230709002824.png"><meta property="og:image" content="https://picgo-1308055782.cos.ap-chengdu.myqcloud.com/picgo-core/2023/07/20230709002931.png"><meta property="og:image" content="https://picgo-1308055782.cos.ap-chengdu.myqcloud.com/picgo-core/2023/07/20230709002940.png"><meta property="og:image" content="https://picgo-1308055782.cos.ap-chengdu.myqcloud.com/picgo-core/2023/07/20230709002946.png"><meta property="og:image" content="https://picgo-1308055782.cos.ap-chengdu.myqcloud.com/picgo-core/2023/07/20230709002953.png"><meta property="og:image" content="https://picgo-1308055782.cos.ap-chengdu.myqcloud.com/picgo-core/2023/07/20230709002958.png"><meta property="og:image" content="https://picgo-1308055782.cos.ap-chengdu.myqcloud.com/picgo-core/2023/07/20230709003014.gif"><meta property="article:published_time" content="2023-07-09T00:00:00.000Z"><meta property="article:modified_time" content="2023-07-09T17:42:09.898Z"><meta property="article:author" content="Chlorine"><meta property="article:tag" content="websocket"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://picgo-1308055782.cos.ap-chengdu.myqcloud.com/picgo-core/2023/07/20230709002811.png"><link rel="icon" type="image/png" href="/images/favicon.ico" sizes="192x192"><link rel="apple-touch-icon" sizes="180x180" href="/images/favicon.ico"><meta name="theme-color" content="#A31F34"><link rel="shortcut icon" href="/images/favicon.ico"><title>WebSocket åº”ç”¨ç ”ç©¶ - Top-Down Web</title><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/fonts/fonts.css"><link rel="stylesheet" href="/fonts/Satoshi/satoshi.css"><link rel="stylesheet" href="/fonts/Chillax/chillax.css"><script id="hexo-configurations">let Global=window.Global||{};Global.hexo_config={hostname:"kiritoking.github.io",root:"/",language:["zh-CN","default"],path:"search.xml"},Global.theme_config={articles:{style:{font_size:"16px",line_height:1.5,image_border_radius:"14px",image_alignment:"center",image_caption:!1,link_icon:!0},word_count:{enable:!0,count:!0,min2read:!0},author_label:{enable:!0,auto:!1,list:[]},code_block:{copy:!0,style:"simple",font:{enable:!1,family:null,url:null}},toc:{enable:!0,max_depth:3,number:!1,expand:!0,init_open:!0},copyright:!0,lazyload:!0,recommendation:{enable:!1,title:"æ¨èé˜…è¯»",limit:3,mobile_limit:2,placeholder:"/images/wallhaven-wqery6-light.webp",skip_dirs:[]}},colors:{primary:"#A31F34",secondary:null},global:{fonts:{chinese:{enable:!1,family:null,url:null},english:{enable:!1,family:null,url:null}},content_max_width:"1000px",sidebar_width:"210px",hover:{shadow:!0,scale:!1},scroll_progress:{bar:!1,percentage:!1},busuanzi_counter:{enable:!1,site_pv:!1,site_uv:!1,post_pv:!1},pjax:!0,open_graph:!0,google_analytics:{enable:!1,id:null},chinese:{enable:!1,family:"Noto Sans SC",url:"https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&display=swap"}},home_banner:{enable:!0,style:"static",image:{light:"/images/wallhaven-wqery6-light.webp",dark:"/images/wallhaven-wqery6-dark.webp"},title:"Develop web apps from top to down.",subtitle:{text:["Stay Hungry, Stay Foolish.","Keep Your Curiosity.","Top to Down, Front to Back."],hitokoto:{enable:!1,api:"https://v1.hitokoto.cn"},typing_speed:100,backing_speed:80,starting_delay:500,backing_delay:1500,loop:!0,smart_backspace:!0},text_color:{light:"#fff",dark:"#d1d1b6"},text_style:{title_size:"2.8rem",subtitle_size:"1.5rem",line_height:1.2},custom_font:{enable:!1,family:null,url:null},social_links:{enable:!0,links:{github:"https://github.com/KiritoKing",instagram:null,zhihu:"https://www.zhihu.com/people/kirito-38",twitter:null,email:null,bilibili:"https://space.bilibili.com/8408315"}}},plugins:{feed:{enable:!1},aplayer:{enable:!1,type:"fixed",audios:[{name:null,artist:null,url:null,cover:null}]},mermaid:{enable:!1,version:"9.3.0"}},version:"2.2.1",navbar:{auto_hide:!0,color:{left:"#f78736",right:"#367df7",transparency:35},links:{Home:{path:"/",icon:"fa-regular fa-house"},"æ–‡ç« ":{icon:"fa-solid fa-newspaper",submenus:{"åˆ†ç±»":"/categories/","æ ‡ç­¾":"/tags/","å½’æ¡£":"/archives/"}},"ç®€å†":{icon:"fa-solid fa-address-card",path:"https://www.wolai.com/kiritoking/4WWg85fMbYGinKhXQb83vw"},"å‹é“¾":{icon:"fa-solid fa-link",path:"/links/"},Github:{path:"https://www.github.com/KiritoKing",icon:"fa-brands fa-github"}},search:{enable:!0,preload:!0}},page_templates:{friends_column:2,tags_style:"blur"},home:{sidebar:{enable:!0,position:"left",first_item:"menu",announcement:null,links:{"å½’æ¡£":{icon:"fa-regular fa-archive",path:"/archives/"},"æ ‡ç­¾":{icon:"fa-regular fa-tags",path:"/tags"},"åˆ†ç±»":{path:"/categories",icon:"fa-regular fa-folder"}},annoucement:null},article_date_format:"auto",categories:{enable:!0,limit:3},tags:{enable:!0,limit:3}},footerStart:"2023/04/17 14:44:44"},Global.language_ago={second:"%s seconds ago",minute:"%s minutes ago",hour:"%s hours ago",day:"%s days ago",week:"%s weeks ago",month:"%s months ago",year:"%s years ago"},Global.data_config={masonry:!1}</script><link rel="stylesheet" href="/fontawesome/fontawesome.min.css"><link rel="stylesheet" href="/fontawesome/brands.min.css"><link rel="stylesheet" href="/fontawesome/solid.min.css"><link rel="stylesheet" href="/fontawesome/regular.min.css"><meta name="generator" content="Hexo 6.3.0"></head><body><div class="progress-bar-container"><span class="pjax-progress-bar"></span> <span class="pjax-progress-icon"><i class="fa-solid fa-circle-notch fa-spin"></i></span></div><main class="page-container"><div class="main-content-container"><div class="main-content-header"><header class="navbar-container"><div class="navbar-content"><div class="left"><a class="logo-title" href="/">Top-Down Web</a></div><div class="right"><div class="desktop"><ul class="navbar-list"><li class="navbar-item"><a href="/"><i class="fa-regular fa-house"></i> é¦–é¡µ</a></li><li class="navbar-item"><a class="has-dropdown" href="#" onclick="return!1"><i class="fa-solid fa-newspaper"></i> æ–‡ç« &nbsp;<i class="fa-solid fa-chevron-down"></i></a><ul class="sub-menu"><li><a href="/categories/">åˆ†ç±»</a></li><li><a href="/tags/">æ ‡ç­¾</a></li><li><a href="/archives/">å½’æ¡£</a></li></ul></li><li class="navbar-item"><a target="_blank" rel="noopener" href="https://www.wolai.com/kiritoking/4WWg85fMbYGinKhXQb83vw"><i class="fa-solid fa-address-card"></i> ç®€å†</a></li><li class="navbar-item"><a href="/links/"><i class="fa-solid fa-link"></i> å‹é“¾</a></li><li class="navbar-item"><a target="_blank" rel="noopener" href="https://www.github.com/KiritoKing"><i class="fa-brands fa-github"></i> GITHUB</a></li><li class="navbar-item search search-popup-trigger"><i class="fa-solid fa-magnifying-glass"></i></li></ul></div><div class="mobile"><div class="icon-item search search-popup-trigger"><i class="fa-solid fa-magnifying-glass"></i></div><div class="icon-item navbar-bar"><div class="navbar-bar-middle"></div></div></div></div></div><div class="navbar-drawer"><ul class="drawer-navbar-list"><li class="drawer-navbar-item flex-center"><a href="/"><i class="fa-regular fa-house"></i> é¦–é¡µ</a></li><li class="drawer-navbar-item flex-center"><a class="has-dropdown" href="#" onclick="return!1"><i class="fa-solid fa-newspaper"></i> æ–‡ç« &nbsp;<i class="fa-solid fa-chevron-down"></i></a></li><li class="dropdown-item flex-center"><a class="dropdown-item" href="/categories/">åˆ†ç±»</a></li><li class="dropdown-item flex-center"><a class="dropdown-item" href="/tags/">æ ‡ç­¾</a></li><li class="dropdown-item flex-center"><a class="dropdown-item" href="/archives/">å½’æ¡£</a></li><li class="drawer-navbar-item flex-center"><a target="_blank" rel="noopener" href="https://www.wolai.com/kiritoking/4WWg85fMbYGinKhXQb83vw"><i class="fa-solid fa-address-card"></i> ç®€å†</a></li><li class="drawer-navbar-item flex-center"><a href="/links/"><i class="fa-solid fa-link"></i> å‹é“¾</a></li><li class="drawer-navbar-item flex-center"><a target="_blank" rel="noopener" href="https://www.github.com/KiritoKing"><i class="fa-brands fa-github"></i> GITHUB</a></li></ul></div><div class="window-mask"></div></header></div><div class="main-content-body"><div class="main-content"><div class="fade-in-down-animation"><div class="post-page-container"><div class="article-content-container"><div class="article-title"><h1 class="article-title-regular">WebSocket åº”ç”¨ç ”ç©¶</h1></div><div class="article-header"><div class="avatar"><img src="/images/avatar.jpg"></div><div class="info"><div class="author"><span class="name">ChlorineC</span> <span class="author-label">Lv3</span></div><div class="meta-info"><div class="article-meta-info"><span class="article-date article-meta-item"><i class="fa-regular fa-pen-fancy"></i>&nbsp; <span class="desktop">2023-07-09</span> <span class="mobile">2023-07-09 00</span> <span class="hover-info">åˆ›å»º</span> </span><span class="article-date article-meta-item"><i class="fa-regular fa-wrench"></i>&nbsp; <span class="desktop">2023-07-09 17:42:09</span> <span class="mobile">2023-07-09 17:42</span> <span class="hover-info">æ›´æ–°</span> </span><span class="article-categories article-meta-item"><i class="fa-regular fa-folders"></i>&nbsp;<ul><li><a href="/categories/%E5%89%8D%E7%AB%AF/">å‰ç«¯</a>&nbsp;</li></ul></span><span class="article-tags article-meta-item"><i class="fa-regular fa-tags"></i>&nbsp;<ul><li><a href="/tags/websocket/">websocket</a>&nbsp;</li></ul></span></div></div></div></div><div class="article-content markdown-body"><h2 id="äº†è§£WebSocketåè®®">äº†è§£WebSocketåè®®</h2><p>åœ¨ WebSocket å‡ºç°ä¹‹å‰ï¼Œå¦‚æœæˆ‘ä»¬æƒ³å®ç°å®æ—¶é€šä¿¡ï¼Œæ¯”è¾ƒå¸¸é‡‡ç”¨çš„æ–¹å¼æ˜¯ Ajax è½®è¯¢ï¼Œå³åœ¨ç‰¹å®šæ—¶é—´é—´éš”ï¼ˆæ¯”å¦‚æ¯ç§’ï¼‰ç”±æµè§ˆå™¨å‘å‡ºè¯·æ±‚ï¼ŒæœåŠ¡å™¨è¿”å›æœ€æ–°çš„æ•°æ®ã€‚è¿™æ ·åšçš„é—®é¢˜æœ‰ï¼š</p><ul><li>HTTPå¤´éƒ¨é‡å¤ä¿¡æ¯è¾ƒå¤šï¼Œæœ‰æ•ˆè½½è·å°‘</li><li>æœåŠ¡å™¨<strong>è¢«åŠ¨</strong>æ¥æ”¶æµè§ˆå™¨çš„è¯·æ±‚ç„¶åå“åº”ï¼Œæ•°æ®æ²¡æœ‰æ›´æ–°æ—¶ä»ç„¶è¦æ¥æ”¶å¹¶å¤„ç†è¯·æ±‚ï¼Œå¯¼è‡´æœåŠ¡å™¨ CPU å ç”¨</li></ul><p>WebSocketåè®®çš„å‡ºç°è§£å†³äº†ä¸Šè¿°é—®é¢˜ï¼š</p><ul><li>WebSocketå»ºç«‹è¿æ¥åä¸å†å‘é€HTTPå¤´ï¼ŒWebSocket çš„å¤´éƒ¨ä¿¡æ¯å°‘ï¼Œé€šå¸¸åªæœ‰ 2Bytes å·¦å³ï¼Œèƒ½èŠ‚çœå¸¦å®½</li><li>WebSocket æ”¯æŒæœåŠ¡ç«¯ä¸»åŠ¨æ¨é€æ¶ˆæ¯ï¼Œæ›´å¥½åœ°æ”¯æŒå®æ—¶é€šä¿¡</li></ul><p>ç”±äºä¸Šè¿°ç‰¹ç‚¹ï¼ŒWSå¹¿æ³›åº”ç”¨äº<strong>è§†é¢‘å¼¹å¹•ã€åœ¨çº¿èŠå¤©ã€éŸ³è§†é¢‘é€šè¯ã€å®æ—¶å®šä½</strong>ç­‰åœºæ™¯ã€‚</p><blockquote><p>ğŸŒŸWebSocketå·²ç»æˆä¸ºHTML5æ ‡å‡†ä¹‹ä¸€ï¼Œè¢«ç›®å‰æ‰€æœ‰ä¸»æµæµè§ˆå™¨æ”¯æŒï¼Œå†…éƒ¨æä¾›<code>WebSocket()</code> API</p></blockquote><h3 id="é€šä¿¡åŸç†è§£æ">é€šä¿¡åŸç†è§£æ</h3><blockquote><p>WebSocket æ˜¯åŸºäº TCP çš„ä¸€ç§æ–°çš„åº”ç”¨å±‚ç½‘ç»œåè®®ã€‚å®ƒå®ç°äº†æµè§ˆå™¨ä¸æœåŠ¡å™¨å…¨åŒå·¥é€šä¿¡ï¼Œå³å…è®¸æœåŠ¡å™¨ä¸»åŠ¨å‘é€ä¿¡æ¯ç»™å®¢æˆ·ç«¯ã€‚å› æ­¤ï¼Œåœ¨ WebSocket ä¸­ï¼Œæµè§ˆå™¨å’ŒæœåŠ¡å™¨åªéœ€è¦å®Œæˆä¸€æ¬¡æ¡æ‰‹ï¼Œä¸¤è€…ä¹‹é—´å°±ç›´æ¥å¯ä»¥åˆ›å»ºæŒä¹…æ€§çš„è¿æ¥ï¼Œå¹¶è¿›è¡ŒåŒå‘æ•°æ®ä¼ è¾“ï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´çš„æ•°æ®äº¤æ¢å˜å¾—æ›´åŠ ç®€å•ã€‚</p></blockquote><p>WebSocketçš„ç‰¹ç‚¹å¦‚ä¸‹ï¼š</p><ul><li>æ¡æ‰‹æ—¶ä½¿ç”¨<strong>HTTPåè®®è¯·æ±‚åè®®å‡çº§</strong>ï¼Œæ¡æ‰‹æˆåŠŸåä½¿ç”¨<strong>TCP</strong>ç›´æ¥é€šä¿¡</li><li><strong>ç‹¬ç«‹</strong>çš„åº”ç”¨å±‚åè®®ï¼Œ<strong>ç«¯å£</strong>é»˜è®¤å¤ç”¨<strong>HTTPçš„80ï¼ˆwsï¼‰<strong>å’Œ</strong>HTTPSçš„443ï¼ˆwssï¼‰</strong></li><li><strong>å…¨åŒå·¥</strong>é€šä¿¡ï¼ŒåŒæ–¹éƒ½å¯ä»¥ä¸»åŠ¨å‘å¯¹æ–¹æ¨é€ä¿¡æ¯</li></ul><p><img lazyload src="/images/loading.svg" data-src="https://picgo-1308055782.cos.ap-chengdu.myqcloud.com/picgo-core/2023/07/20230709002811.png" alt="" title="WSå¯¹æ¯”HTTP"></p><h4 id="å»ºç«‹è¿æ¥">å»ºç«‹è¿æ¥</h4><p>ç›´æ¥å‘WSæœåŠ¡å™¨å‘é€è¯·æ±‚åˆ‡æ¢åè®®çš„æŠ¥æ–‡ï¼ˆé»˜è®¤å°±æ˜¯HTTPçš„ç«¯å£ï¼Œä¹Ÿå¯ä»¥æŒ‡å®šç«¯å£ï¼‰</p><p><img lazyload src="/images/loading.svg" data-src="https://picgo-1308055782.cos.ap-chengdu.myqcloud.com/picgo-core/2023/07/20230709002816.png" alt=""></p><ul><li>å®¢æˆ·ç«¯è¯·æ±‚åŒ…å«<code>Connection: Upgrade</code> è¡¨ç¤ºè¦å‡çº§åè®®ï¼Œä»¥åŠ<code>Upgrade: websocket</code>å­—æ®µè¯´æ˜è¦åˆ‡æ¢åˆ°WSåè®®ï¼Œä»¥ä¸ŠæŠ¥æ–‡åˆ›å»ºå·¥ä½œç”±æµè§ˆå™¨ä¸­çš„<code>WebSocket</code> åŠŸèƒ½å®Œæˆ</li><li>æœåŠ¡å™¨è¿”å›çŠ¶æ€ç 101è¡¨ç¤ºåè®®åˆ‡æ¢å®Œæˆï¼Œå¯ä»¥è¿›è¡Œå…¨åŒå·¥é€šä¿¡ï¼Œåœ¨ä¸Šæ–¹çš„â€œæ¶ˆæ¯â€å¯ä»¥æŸ¥çœ‹</li></ul><p><img lazyload src="/images/loading.svg" data-src="https://picgo-1308055782.cos.ap-chengdu.myqcloud.com/picgo-core/2023/07/20230709002824.png" alt=""></p><h4 id="æ•°æ®äº¤æ¢">æ•°æ®äº¤æ¢</h4><blockquote><p>ğŸš¦éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™äº›å·¥ä½œåœ¨å®é™…ä½¿ç”¨æ—¶<strong>ç”±æœåŠ¡ç«¯å’Œæµè§ˆå™¨è‡ªåŠ¨å®Œæˆï¼Œä½¿ç”¨è€…ä¸éœ€è¦å…³å¿ƒ</strong>ã€‚</p></blockquote><p>WebSocketåè®®ä½¿ç”¨è‡ªå·±çš„å¸§ï¼ˆframeï¼‰ç»“æ„ä¼ é€’ä¿¡æ¯ï¼Œ<strong>ä¸€æ¡WSæ¶ˆæ¯å¯èƒ½è¢«åˆ†æˆè‹¥å¹²WSå¸§è¿›è¡Œå‘é€ï¼Œåœ¨æ¥æ”¶ç«¯é‡æ–°ç»„è£…</strong>ã€‚</p><p>WSå¸§ç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img lazyload src="/images/loading.svg" data-src="https://picgo-1308055782.cos.ap-chengdu.myqcloud.com/picgo-core/2023/07/20230709002931.png" alt=""></p><p>WSæŠ¥æ–‡å¤´å’ŒHTTPä¸åŒï¼Œä¸åŒ…æ‹¬ç¹æ‚çš„Headerä¿¡æ¯ï¼ŒåªåŒ…å«åŸºç¡€çš„ä¸‰é¡¹ï¼š</p><ul><li><code>FIN</code> è¡¨ç¤ºå½“å‰å¸§æ˜¯å¦æ˜¯å½“å‰æ¶ˆæ¯çš„æœ€åå¸§</li><li><code>opcode</code> æ“ä½œç ï¼Œè¡¨ç¤ºå½“å‰è¯·æ±‚çš„ç±»å‹<ul><li>0x0ï¼Œè¡¨ç¤ºè¯¥å¸§æ˜¯ä¸€ä¸ª<strong>å»¶ç»­å¸§</strong>ï¼ˆè¿™æ„å‘³ç€æœåŠ¡å™¨åº”è¯¥å°†å¸§çš„æ•°æ®è¿æ¥åˆ°ä»è¯¥å®¢æˆ·ç«¯æ¥æ”¶åˆ°çš„æœ€åä¸€ä¸ªå¸§ï¼‰ï¼›</li><li>0x1ï¼Œä¼ è¾“æ•°æ®æ˜¯æ–‡æœ¬ï¼›</li><li>0x2ï¼Œä¼ è¾“æ•°æ®æ˜¯äºŒè¿›åˆ¶æ•°æ®ï¼›</li><li>0x3-7ï¼šä¿ç•™çš„æ“ä½œä»£ç ï¼Œç”¨äºåç»­å®šä¹‰çš„éæ§åˆ¶å¸§ï¼›</li><li>0x8ï¼šè¡¨ç¤ºè¿æ¥æ–­å¼€ï¼›</li><li>0x9ï¼šè¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªå¿ƒè·³è¯·æ±‚ï¼ˆpingï¼‰ï¼›</li><li>0xAï¼šè¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªå¿ƒè·³å“åº”ï¼ˆpongï¼‰ï¼›</li><li>0xB-Fï¼šä¿ç•™çš„æ“ä½œä»£ç ï¼Œç”¨äºåç»­å®šä¹‰çš„æ§åˆ¶å¸§ï¼›</li></ul></li><li><code>len</code> è¡¨ç¤ºè½½è·çš„é•¿åº¦</li></ul><h4 id="ç»´æŒè¿æ¥ï¼šå¿ƒè·³æœºåˆ¶">ç»´æŒè¿æ¥ï¼šå¿ƒè·³æœºåˆ¶</h4><p>ç”±äºWebSocketæ˜¯å…¨åŒå·¥ã€ä¿æŒè¿æ¥çš„æœºåˆ¶ï¼Œæˆ‘ä»¬éœ€è¦é€šè¿‡ä¸€å®šæ‰‹æ®µæ¥ç¡®å®šè¿æ¥æ­£å¸¸æ²¡æœ‰æ–­å¼€æˆ–è€…æœåŠ¡æ˜¯å¦å¯ç”¨ï¼Œè¿™å°±æ˜¯<strong>å¿ƒè·³æœºåˆ¶</strong>ã€‚</p><p>å¯ä»¥çœ‹è§ï¼Œä¸Šé¢çš„æ“ä½œç ä¸­å®šä¹‰äº†ç”¨äºå¿ƒè·³è¯·æ±‚å’Œå“åº”çš„ä½ï¼Œå¯ä»¥é€šè¿‡<strong>å®šæ—¶å‘é€</strong>å¯¹åº”æ•°æ®åŒ…æ¥ç¡®å®šè®©å¯¹æ–¹çŸ¥é“è‡ªå·±åœ¨çº¿ä¸”æ­£å¸¸å·¥ä½œï¼Œç¡®ä¿é€šä¿¡æœ‰æ•ˆã€‚å¦‚æœå¯¹æ–¹æ— æ³•å“åº”ï¼Œä¾¿å¯ä»¥å¼ƒç”¨æ—§è¿æ¥ï¼Œå‘èµ·æ–°çš„è¿æ¥äº†ã€‚</p><p>åœ¨JSä¸­æˆ‘ä»¬å¯ä»¥ç®€å•åœ°ç”¨<code>setInterval()</code> åˆ›å»ºå®šæ—¶å™¨å‘é€æ¶ˆæ¯å³å¯ã€‚</p><h3 id="Node-js-å®è·µ">Node.js å®è·µ</h3><p>é€šè¿‡ç”¨Node.jsåŸç”Ÿçš„<code>ws</code> åº“å®ç°ä¸€ä¸ªåŸºç¡€çš„WebSocketèŠå¤©å®¤ï¼Œç†è§£WebSocketåœ¨å®é™…ä½¿ç”¨è¿‡ç¨‹ä¸­çš„è°ƒç”¨æµç¨‹å’ŒæŠ½è±¡æ¨¡å‹ã€‚</p><h4 id="åˆ›å»ºæœåŠ¡ç«¯">åˆ›å»ºæœåŠ¡ç«¯</h4><p>é¦–å…ˆåˆå§‹åŒ–ä¸€ä¸ªé¡¹ç›®ï¼Œè¿™é‡Œä½¿ç”¨ <code>pnpm init</code> ï¼Œå¹¶å®‰è£…ä¾èµ– <code>pnpm add ws</code>ã€‚</p><blockquote><p>è¿™é‡ŒåŸºäºä¸ªäººçˆ±å¥½ï¼Œæˆ‘åœ¨<code>package.json</code> ä¸­å†™å…¥äº† <code>&quot;type&quot;: &quot;module&quot;</code> ä»¥å¯ç”¨ESMï¼Œå¦‚æœä½ ä¹ æƒ¯ä½¿ç”¨CJSè¯·ç•™æ„ä»£ç ä¸­çš„å¯¼å…¥éƒ¨åˆ†ã€‚</p></blockquote><p>åœ¨å†™ä»£ç ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆé˜…è¯»wsçš„<a class="link" target="_blank" rel="noopener" href="https://github.com/websockets/ws/blob/HEAD/doc/ws.md" title="æ–‡æ¡£">æ–‡æ¡£ <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a>å’Œå¤„ç†æµç¨‹ï¼š</p><blockquote><p>ğŸŒŸæœåŠ¡ç«¯ä½¿ç”¨ <code>WebSocketServer</code> åˆ›å»ºä¸€ä¸ªæœåŠ¡ç«¯å®ä¾‹ï¼Œå¯¹äºæ¯ä¸ªè¿æ¥åˆ›å»ºä¸€ä¸ª <code>WebSocket</code> å®ä¾‹ï¼Œä¸€ä¸ª<code>WebSocketServer</code> å®ä¾‹ç®¡ç†å¤šä¸ª<code>WebSocket</code> å®ä¾‹ã€‚<code>WebSocketServer</code>é€šè¿‡<code>connection</code> äº‹ä»¶ä¸<code>WebSocket</code> å®ä¾‹è¿æ¥ï¼Œæ¯ä¸ª<code>WebSocket</code> å®ä¾‹å¯¹åº”å®é™…çš„WSè¿æ¥ã€‚</p></blockquote><ul><li>æ•´ä¸ªå¤„ç†æµç¨‹<strong>åŸºäºäº‹ä»¶é©±åŠ¨</strong>ï¼Œå³<strong>åœ¨<code>connection</code>äº‹ä»¶ä¸­è·å–å½“å‰è¿æ¥çš„****<code>WebSocket</code>**** å®ä¾‹å¹¶ç»™å®ƒç»‘å®šå¯¹åº”çš„äº‹ä»¶å¤„ç†å™¨</strong><ul><li><code>connection</code> ï¼šè¿æ¥äº‹ä»¶ï¼Œä¸€åˆ‡æ“ä½œçš„èµ·ç‚¹ï¼Œ<strong>åªæœ‰å®ƒç»‘å®šåœ¨Serverä¸Š</strong><ul><li><code>socket</code> å‚æ•°å¯ä»¥è·å¾—å½“å‰è¿æ¥çš„WebSocketå®ä¾‹</li><li><code>request</code> å‚æ•°å¯ä»¥è·å¾—å½“å‰è¿æ¥è¯·æ±‚çš„æ‰€æœ‰HTTPæŠ¥æ–‡ä¿¡æ¯ï¼Œå¦‚Originã€Cookieç­‰</li></ul></li><li><code>message</code> ï¼šæ¥æ”¶åˆ°æŸä¸ªSocketä¼ æ¥çš„æ¶ˆæ¯çš„äº‹ä»¶ï¼Œå‚æ•°ä¸º<code>data</code> ï¼Œå³æ¶ˆæ¯çš„è½½è·ï¼Œå¯ä»¥æ˜¯æ–‡æœ¬ã€Bufferæˆ–äºŒè¿›åˆ¶</li><li><code>close</code> ï¼šæœåŠ¡å…³é—­äº‹ä»¶ï¼Œ<strong>ç”±äºWebSocketæ˜¯å…¨åŒå·¥åè®®ï¼Œåœ¨æœåŠ¡æ­£å¼å…³é—­æ—¶ï¼ˆä»»ä½•ä¸€æ–¹</strong>**<code>close()</code>ï¼‰åŒæ–¹éƒ½ä¼šæ”¶åˆ°å…³é—­æŠ¥æ–‡å’Œå¯¹åº”äº‹ä»¶**â€‹</li></ul></li><li><code>WebSocketServer</code> å®ä¾‹å¯ä»¥<strong>ç®¡ç†æ‰€æœ‰è¿æ¥çš„Sockets</strong>ï¼ˆé»˜è®¤å¯ä»¥å¤šè¿æ¥ï¼‰ï¼Œä½¿ç”¨<code>clients</code> å±æ€§è·å–ä¸å½“å‰æœåŠ¡å™¨è¿æ¥çš„æ‰€æœ‰<code>WebSocket</code>å®ä¾‹ <strong>ï¼ˆå¯ä»¥ç”¨æ¥å®ç°å¹¿æ’­ï¼‰</strong></li><li><code>WebSocket</code> å®ä¾‹å¯¹åº”äº†ä¸€ä¸ªWebSocketè¿æ¥ï¼Œå¸¸ç”¨çš„APIå¦‚ä¸‹ï¼š<ul><li><code>Event</code> æ¥å£ï¼šä¸€èˆ¬åŒ…å«äº†<code>type</code>, <code>data</code>, <code>target</code> ç­‰å±æ€§å¯ä»¥è°ƒç”¨<ul><li><code>type</code> ï¼šäº‹ä»¶å±æ€§ï¼Œå¦‚message, close, connectionç­‰</li><li><code>data</code>ï¼šæœ‰æ•ˆè½½è·</li><li><code>target</code>ï¼šä¸€èˆ¬å¯¹åº”<code>WebSocket</code>å®ä¾‹</li></ul></li><li><code>url</code> å±æ€§ï¼šç›®æ ‡WSæœåŠ¡å™¨åœ°å€</li><li><code>send(data, [options], [callback])</code> æ–¹æ³•ï¼šå‘<strong>å¯¹æ–¹</strong>å‘é€ä¿¡æ¯ï¼ˆæœåŠ¡ç«¯ä¹Ÿå¯ä»¥è°ƒç”¨ï¼‰</li><li><code>close([ErrorCode], [data])</code> æ–¹æ³•ï¼šå…³é—­è¿æ¥</li></ul></li></ul><p>åˆ›å»ºä¸€ä¸ª<strong>åŸºç¡€æœåŠ¡ç«¯</strong>å’Œä¸€ä¸ª<strong>ç”¨äºæµ‹è¯•çš„å®¢æˆ·ç«¯</strong>ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><div class="highlight-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// server.js</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">WebSocketServer</span>, <span class="title class_">WebSocket</span> &#125; <span class="keyword">from</span> <span class="string">&quot;ws&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> server = <span class="keyword">new</span> <span class="title class_">WebSocketServer</span>(&#123; <span class="attr">port</span>: <span class="number">4567</span> &#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">broadcast</span>(<span class="params">msg, user, source</span>) &#123;</span><br><span class="line">  server.<span class="property">clients</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">client</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (client.<span class="property">readyState</span> === <span class="title class_">WebSocket</span>.<span class="property">OPEN</span> &amp;&amp; client !== source) &#123;</span><br><span class="line">      client.<span class="title function_">send</span>(<span class="string">`[<span class="subst">$&#123;user&#125;</span>] <span class="subst">$&#123;msg&#125;</span>`</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server.<span class="title function_">on</span>(<span class="string">&#x27;connection&#x27;</span>, <span class="function">(<span class="params">socket, req</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> user = req.<span class="property">headers</span>.<span class="property">origin</span>;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`[Server] connected: <span class="subst">$&#123;user&#125;</span>`</span>);</span><br><span class="line">  socket.<span class="title function_">on</span>(<span class="string">&#x27;message&#x27;</span>, <span class="function">(<span class="params">msg</span>) =&gt;</span> &#123; </span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`From <span class="subst">$&#123;user&#125;</span>: <span class="subst">$&#123;msg&#125;</span>`</span>);</span><br><span class="line">    socket.<span class="title function_">send</span>(<span class="string">`[Echo] You sent -&gt; <span class="subst">$&#123;msg&#125;</span>`</span>)</span><br><span class="line">    <span class="title function_">broadcast</span>(msg, user, socket);</span><br><span class="line">    <span class="keyword">if</span> (msg === <span class="string">&#x27;bye&#x27;</span>) &#123;</span><br><span class="line">      socket.<span class="title function_">close</span>(<span class="number">0</span>, <span class="string">&quot;Bye&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">  socket.<span class="title function_">on</span>(<span class="string">&#x27;close&#x27;</span>, <span class="function">(<span class="params">code, reason</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`[Server] Connection closed with code: <span class="subst">$&#123;code&#125;</span> for <span class="subst">$&#123;reason&#125;</span>`</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;WebSocket Server started at port 4567...&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// client.js</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">WebSocket</span> &#125; <span class="keyword">from</span> <span class="string">&quot;ws&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> socket = <span class="keyword">new</span> <span class="title class_">WebSocket</span>(<span class="string">&#x27;ws://localhost:4567&#x27;</span>, &#123; <span class="attr">origin</span>: ((<span class="title class_">Math</span>.<span class="title function_">random</span>()*<span class="number">10</span>).<span class="title function_">toFixed</span>(<span class="number">0</span>)).<span class="title function_">toString</span>() &#125;);</span><br><span class="line"></span><br><span class="line">socket.<span class="title function_">addEventListener</span>(<span class="string">&#x27;open&#x27;</span>, <span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Connected to server: <span class="subst">$&#123;e.target.url&#125;</span>`</span>)</span><br><span class="line">  socket.<span class="title function_">send</span>(<span class="string">&#x27;Hello Server from NodeJS Client!&#x27;</span>);</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">socket.<span class="title function_">addEventListener</span>(<span class="string">&#x27;message&#x27;</span>, <span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// e.type=äº‹ä»¶ç±»å‹ï¼Œopen|message|close</span></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(e.<span class="property">data</span>);</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">socket.<span class="title function_">addEventListener</span>(<span class="string">&#x27;close&#x27;</span>, <span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Type=<span class="subst">$&#123;e.type&#125;</span>\nCode=<span class="subst">$&#123;e.code&#125;</span>\nReason=<span class="subst">$&#123;e.reason&#125;</span>`</span>);</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> count = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">setInterval</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  socket.<span class="title function_">send</span>(count++);</span><br><span class="line">&#125;, <span class="number">1000</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure></div><p>å¯ä»¥çœ‹åˆ°ï¼Œåœ¨ä¸Šé¢çš„ä»£ç ä¸­æˆ‘ä»¬åˆ©ç”¨<code>clients</code> å±æ€§æ‰‹å†™å®ç°äº†<strong>å¹¿æ’­</strong>åŠŸèƒ½ï¼Œæ‰€è°“WSâ€œä¸æä¾›â€çš„åŠŸèƒ½ï¼Œè¿™é‡Œæˆ‘ä»¬èƒ½çª¥è§ä¸€ç‚¹WebSocketçš„æœ¬è´¨å±æ€§â€”â€”å®ƒåªæ˜¯ä¸€ç§æœåŠ¡åè®®ï¼Œæä¾›äº†ä¸€ç§å…¨åŒå·¥çš„æ²Ÿé€šæ–¹å¼ï¼Œè€Œä¸Šå±‚çš„è°ƒç”¨å’Œå®ç°ã€éœ€è¦ä»€ä¹ˆåŠŸèƒ½åˆ™å®Œå…¨ç”±å¼€å‘è€…å†³å®šï¼Œå°±åƒHTTPä¸€æ ·æ˜¯ä¸€ç§â€œåŸºç¡€è®¾æ–½â€ã€‚</p><p>è¿è¡Œæ•ˆæœå¦‚ä¸‹ï¼š</p><p><img lazyload src="/images/loading.svg" data-src="https://picgo-1308055782.cos.ap-chengdu.myqcloud.com/picgo-core/2023/07/20230709002940.png" alt=""></p><h4 id="åˆ›å»ºå‰ç«¯é¡µé¢">åˆ›å»ºå‰ç«¯é¡µé¢</h4><p>é¦–å…ˆä½¿ç”¨<code>pnpm create vite</code> åˆ›å»ºä¸€ä¸ªSPWåº”ç”¨ï¼Œè¿™é‡Œä½¿ç”¨React+Typescript+SWCçš„æ–¹æ¡ˆï¼Œä½ ä¹Ÿå¯ä»¥æ ¹æ®è‡ªå·±çš„å–œå¥½é€‰æ‹©ã€‚ç„¶åæŒ‰ç…§æµç¨‹<code>pnpm install</code> å®‰è£…ä¾èµ–ã€<code>pnpm run dev</code>å¯åŠ¨å¼€å‘æœåŠ¡å™¨ã€‚</p><h5 id="æ‰‹å†™WebSocket">æ‰‹å†™WebSocket</h5><p>æˆ‘ä»¬ä½¿ç”¨ä¸Šé¢å†™çš„æœåŠ¡ç«¯ä½œä¸ºWebSocketæœåŠ¡å™¨ï¼Œæ”¹å†™<code>./src/App.tsx</code>ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><div class="highlight-container" data-rel="Tsx"><figure class="iseeu highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; useEffect, useMemo, useRef, useState &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;./App.css&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">App</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> ws = useRef&lt;<span class="title class_">WebSocket</span> | <span class="literal">null</span>&gt;(<span class="literal">null</span>);</span><br><span class="line">  <span class="keyword">const</span> [connected, setConnected] = useState&lt;<span class="built_in">boolean</span>&gt;(<span class="literal">false</span>);</span><br><span class="line">  <span class="keyword">const</span> [host, setHost] = useState&lt;<span class="built_in">string</span>&gt;(<span class="string">&#x27;localhost:4567&#x27;</span>);</span><br><span class="line">  <span class="keyword">const</span> [send, setSend] = useState&lt;<span class="built_in">string</span>&gt;(<span class="string">&#x27;&#x27;</span>);</span><br><span class="line">  <span class="keyword">const</span> [messages, setMessages] = useState&lt;&#123;</span><br><span class="line">    <span class="attr">category</span>: <span class="string">&#x27;message&#x27;</span> | <span class="string">&#x27;error&#x27;</span> | <span class="string">&#x27;info&#x27;</span>,</span><br><span class="line">    <span class="attr">message</span>: <span class="built_in">string</span></span><br><span class="line">  &#125;[]&gt;([]);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">handleConnect</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (ws.<span class="property">current</span> &amp;&amp; ws.<span class="property">current</span>.<span class="property">readyState</span> === <span class="title class_">WebSocket</span>.<span class="property">OPEN</span>) &#123; </span><br><span class="line">      messages.<span class="title function_">push</span>(&#123;<span class="attr">category</span>: <span class="string">&#x27;info&#x27;</span>, <span class="attr">message</span>: <span class="string">&#x27;Already connected!&#x27;</span>&#125;);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ws.<span class="property">current</span> = <span class="keyword">new</span> <span class="title class_">WebSocket</span>(<span class="string">&#x27;ws://&#x27;</span> + host);</span><br><span class="line">    ws.<span class="property">current</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;open&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      messages.<span class="title function_">push</span>(&#123;<span class="attr">category</span>: <span class="string">&#x27;info&#x27;</span>, <span class="attr">message</span>: <span class="string">&#x27;Connected to &#x27;</span> + ws.<span class="property">current</span>!.<span class="property">url</span>&#125;);</span><br><span class="line">      <span class="title function_">setMessages</span>([...messages])</span><br><span class="line">      <span class="title function_">setConnected</span>(<span class="literal">true</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    ws.<span class="property">current</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;message&#x27;</span>, <span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">      messages.<span class="title function_">push</span>(&#123;<span class="attr">category</span>: <span class="string">&#x27;message&#x27;</span>, <span class="attr">message</span>: event.<span class="property">data</span> <span class="keyword">as</span> <span class="built_in">string</span>&#125;);</span><br><span class="line">      <span class="title function_">setMessages</span>([...messages])</span><br><span class="line">    &#125;);</span><br><span class="line">    ws.<span class="property">current</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;close&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      messages.<span class="title function_">push</span>(&#123;<span class="attr">category</span>: <span class="string">&#x27;info&#x27;</span>, <span class="attr">message</span>: <span class="string">&#x27;Disconnected from &#x27;</span> + ws.<span class="property">current</span>!.<span class="property">url</span>&#125;);</span><br><span class="line">      <span class="title function_">setMessages</span>([...messages])</span><br><span class="line">    &#125;);</span><br><span class="line">    ws.<span class="property">current</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;error&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      messages.<span class="title function_">push</span>(&#123; <span class="attr">category</span>: <span class="string">&#x27;error&#x27;</span>, <span class="attr">message</span>: <span class="string">&#x27;Error Connection&#x27;</span> &#125;);</span><br><span class="line">      <span class="title function_">setMessages</span>([...messages])</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">handleDisconnect</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (ws.<span class="property">current</span> &amp;&amp; ws.<span class="property">current</span>.<span class="property">readyState</span> === <span class="title class_">WebSocket</span>.<span class="property">OPEN</span>) &#123;</span><br><span class="line">      ws.<span class="property">current</span>.<span class="title function_">close</span>();</span><br><span class="line">      <span class="title function_">setMessages</span>([]);</span><br><span class="line">      <span class="title function_">setConnected</span>(<span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">handleSendMessage</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (ws.<span class="property">current</span> &amp;&amp; ws.<span class="property">current</span>.<span class="property">readyState</span> === <span class="title class_">WebSocket</span>.<span class="property">OPEN</span>) &#123;</span><br><span class="line">      ws.<span class="property">current</span>.<span class="title function_">send</span>(send);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> texts = <span class="title function_">useMemo</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> messages.<span class="title function_">map</span>(<span class="function">(<span class="params">&#123; category, message &#125;, index</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&#123;category&#125;</span> <span class="attr">key</span>=<span class="string">&#123;index&#125;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        &#123;`[$&#123;category.toUpperCase()&#125;] $&#123;message&#125;`&#125;</span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;, [messages])</span><br><span class="line"></span><br><span class="line">  <span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="title function_">handleDisconnect</span>();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;, [])</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&#x27;flex-container&#x27;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">value</span>=<span class="string">&#123;host&#125;</span> <span class="attr">onChange</span>=<span class="string">&#123;(e)</span> =&gt;</span> setHost(e.target.value)&#125; /&gt;</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">button</span> <span class="attr">disabled</span>=<span class="string">&#123;connected&#125;</span> <span class="attr">onClick</span>=<span class="string">&#123;handleConnect&#125;</span>&gt;</span>Connect<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">button</span> <span class="attr">disabled</span>=<span class="string">&#123;!connected&#125;</span> <span class="attr">onClick</span>=<span class="string">&#123;handleDisconnect&#125;</span>&gt;</span>Disconnect<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      &#123;</span></span><br><span class="line"><span class="language-xml">        connected &amp;&amp;</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&#x27;flex-container sender&#x27;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">input</span> <span class="attr">value</span>=<span class="string">&#123;send&#125;</span> <span class="attr">onChange</span>=<span class="string">&#123;(e)</span> =&gt;</span> &#123;setSend(e.target?.value)&#125;&#125; /&gt;</span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;handleSendMessage&#125;</span>&gt;</span>Send<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;()</span> =&gt;</span> setMessages([])&#125;&gt;Clear<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      &#125;      </span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&#x27;log-div&#x27;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        &#123;texts&#125;</span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  )</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title class_">App</span></span><br></pre></td></tr></table></figure></div><p>éƒ¨åˆ†CSSæ ·å¼å¦‚ä¸‹ï¼š</p><div class="highlight-container" data-rel="Css"><figure class="iseeu highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.flex-container</span> &#123;</span><br><span class="line">  <span class="attribute">display</span>: flex;</span><br><span class="line">  <span class="attribute">gap</span>: <span class="number">10px</span>;</span><br><span class="line">  <span class="attribute">flex-wrap</span>: wrap;</span><br><span class="line">  <span class="attribute">justify-content</span>: center;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.log-div</span> &#123;</span><br><span class="line">  <span class="attribute">background-color</span>: aliceblue;</span><br><span class="line">  <span class="attribute">border-radius</span>: <span class="number">10px</span>;</span><br><span class="line">  <span class="attribute">height</span>: <span class="number">500px</span>;</span><br><span class="line">  <span class="attribute">overflow-y</span>: scroll;</span><br><span class="line">  <span class="attribute">overflow-x</span>: hidden;</span><br><span class="line">  <span class="attribute">margin</span>: <span class="number">20px</span> <span class="number">0</span>;</span><br><span class="line">  <span class="attribute">display</span>: flex;</span><br><span class="line">  <span class="attribute">flex-direction</span>: column;</span><br><span class="line">  <span class="attribute">align-items</span>: flex-start;</span><br><span class="line">  <span class="attribute">justify-content</span>: flex-start;</span><br><span class="line">  <span class="attribute">padding</span>: <span class="number">5px</span> <span class="number">10px</span>;</span><br><span class="line">  <span class="attribute">width</span>: <span class="number">100%</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.log-div</span> <span class="selector-tag">div</span> &#123;</span><br><span class="line">  <span class="attribute">margin</span>: <span class="number">5px</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.log-div</span> <span class="selector-class">.info</span> &#123;</span><br><span class="line">  <span class="attribute">color</span>: <span class="number">#888</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.log-div</span> <span class="selector-class">.error</span> &#123;</span><br><span class="line">  <span class="attribute">color</span>: <span class="number">#ff0000</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.sender</span> &#123;</span><br><span class="line">  <span class="attribute">margin</span>: <span class="number">10px</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.sender</span> <span class="selector-tag">input</span> &#123;</span><br><span class="line">  <span class="attribute">width</span>: <span class="number">500px</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>ä»ä»£ç ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°æˆ‘ä»¬ä½¿ç”¨äº†<code>ref</code> ç®¡ç†WSå®ä¾‹ï¼ˆä¸ä¼šéšè§†å›¾æ¸²æŸ“æ”¹å˜çš„å˜é‡ï¼‰ï¼Œå¹¶ä½¿ç”¨å‡ ä¸ª<code>state</code> æ¥ç®¡ç†æ¶ˆæ¯åˆ—è¡¨ã€è¿æ¥çŠ¶æ€å’Œè¾“å…¥æ¡†ç¼“å­˜ï¼Œæœ€åå°†è¿æ¥å’Œå‘é€æ“ä½œå°è£…ä¸ºå¯è°ƒç”¨çš„æ–¹æ³•ã€‚</p><p>æœ€ç»ˆæ•ˆæœå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œå¯ä»¥çœ‹åˆ°å°½ç®¡æ¥è‡ªåŒä¸€åŸŸåï¼Œæˆ‘ä»¬çš„WebSocketæœåŠ¡å™¨ä¹Ÿèƒ½åŒºåˆ†ä¸åŒä¼šè¯ã€‚</p><p><img lazyload src="/images/loading.svg" data-src="https://picgo-1308055782.cos.ap-chengdu.myqcloud.com/picgo-core/2023/07/20230709002946.png" alt=""></p><h5 id="ä½¿ç”¨react-use-websocket">ä½¿ç”¨<code>react-use-websocket</code></h5><p>åœ¨ä¸Šé¢çš„å¼€å‘è¿‡ç¨‹ä¸­æˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œå»ºç«‹WebSocketè¿æ¥å…¶å®æ˜¯ä¸€ä¸ªå¯ä»¥æŠ½è±¡çš„é€»è¾‘ï¼Œä»¥ä¾›é‡å¤è°ƒç”¨ï¼Œåœ¨Reactä¸­ä¹Ÿå°±æ˜¯æŠ½è±¡ä¸ºä¸€ä¸ªHookï¼Œæ¯æ¬¡éœ€è¦ç”¨åˆ°WebSocketçš„æ—¶å€™å°±è°ƒç”¨è¿™ä¸ªHookã€‚</p><p>è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ä¸€ä¸ªåä¸º<code>react-use-websocket</code>çš„npmåŒ…ï¼Œå…ˆå®‰è£…å®ƒ <code>pnpm add react-use-websocket</code> ï¼ˆå¦‚æœä½ ä½¿ç”¨React17åŠä»¥ä¸‹è¯·å®‰è£…3.0.0ç‰ˆæœ¬ï¼‰ã€‚ä½¿ç”¨å°è£…å¥½çš„åŒ…çš„å¥½å¤„æ˜¯èŠ‚çœå¼€å‘æ—¶é—´å’Œæä¾›æ›´å¥å£®å’Œå…¨é¢çš„å°è£…ï¼Œé¿å…è‡ªå·±å¼€å‘æ—¶æ²¡æœ‰è€ƒè™‘åˆ°çš„è¾¹ç•Œæƒ…å†µå¼•å‘çš„Bugsï¼ˆä½†ä¸æ˜¯ç»å¯¹çš„ï¼‰ã€‚</p><p><code>react-use-websocket</code> æä¾›çš„APIå¦‚ä¸‹ï¼ˆCopyè‡ªå®˜æ–¹æ–‡æ¡£ï¼‰ï¼Œå¯ä»¥çœ‹åˆ°å®ƒç›´æ¥ä¸ºæˆ‘ä»¬å°è£…å¥½äº†ä¸€ç³»åˆ—çš„è¡Œä¸ºï¼ˆå¦‚<strong>å¿ƒè·³é‡è¿</strong>ã€JSONå°è£…ç­‰ï¼‰ï¼Œå°†åŸºç¡€çš„<code>ReadyState</code>å±æ€§ã€<code>send</code> æ“ä½œç­‰æš´éœ²äº†å‡ºæ¥ï¼š</p><div class="highlight-container" data-rel="Typescript"><figure class="iseeu highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> <span class="title class_">UseWebSocket</span> = (</span><br><span class="line">  <span class="comment">//Url can be return value of a memoized async function.</span></span><br><span class="line">  <span class="attr">url</span>: <span class="built_in">string</span> | <span class="function">() =&gt;</span> <span class="title class_">Promise</span>&lt;<span class="built_in">string</span>&gt;,</span><br><span class="line">  <span class="attr">options</span>: &#123;</span><br><span class="line">    fromSocketIO?: <span class="built_in">boolean</span>;</span><br><span class="line">    queryParams?: &#123; [<span class="attr">field</span>: <span class="built_in">string</span>]: <span class="built_in">any</span> &#125;;</span><br><span class="line">    protocols?: <span class="built_in">string</span> | <span class="built_in">string</span>[];</span><br><span class="line">    share?: <span class="built_in">boolean</span>;</span><br><span class="line">    onOpen?: <span class="function">(<span class="params">event: WebSocketEventMap[<span class="string">&#x27;open&#x27;</span>]</span>) =&gt;</span> <span class="built_in">void</span>;</span><br><span class="line">    onClose?: <span class="function">(<span class="params">event: WebSocketEventMap[<span class="string">&#x27;close&#x27;</span>]</span>) =&gt;</span> <span class="built_in">void</span>;</span><br><span class="line">    onMessage?: <span class="function">(<span class="params">event: WebSocketEventMap[<span class="string">&#x27;message&#x27;</span>]</span>) =&gt;</span> <span class="built_in">void</span>;</span><br><span class="line">    onError?: <span class="function">(<span class="params">event: WebSocketEventMap[<span class="string">&#x27;error&#x27;</span>]</span>) =&gt;</span> <span class="built_in">void</span>;</span><br><span class="line">    onReconnectStop?: <span class="function">(<span class="params">numAttempts: <span class="built_in">number</span></span>) =&gt;</span> <span class="built_in">void</span>;</span><br><span class="line">    shouldReconnect?: <span class="function">(<span class="params">event: WebSocketEventMap[<span class="string">&#x27;close&#x27;</span>]</span>) =&gt;</span> <span class="built_in">boolean</span>;</span><br><span class="line">    reconnectInterval?: <span class="built_in">number</span> | (<span class="function">(<span class="params">lastAttemptNumber: <span class="built_in">number</span></span>) =&gt;</span> <span class="built_in">number</span>);</span><br><span class="line">    reconnectAttempts?: <span class="built_in">number</span>;</span><br><span class="line">    filter?: <span class="function">(<span class="params">message: WebSocketEventMap[<span class="string">&#x27;message&#x27;</span>]</span>) =&gt;</span> <span class="built_in">boolean</span>;</span><br><span class="line">    retryOnError?: <span class="built_in">boolean</span>;</span><br><span class="line">    eventSourceOptions?: <span class="title class_">EventSourceInit</span>;</span><br><span class="line">  &#125; = &#123;&#125;,</span><br><span class="line">  <span class="attr">shouldConnect</span>: <span class="built_in">boolean</span> = <span class="literal">true</span>,</span><br><span class="line">): &#123;</span><br><span class="line">  <span class="attr">sendMessage</span>: <span class="function">(<span class="params">message: <span class="built_in">string</span>, keep: <span class="built_in">boolean</span> = <span class="literal">true</span></span>) =&gt;</span> <span class="built_in">void</span>,</span><br><span class="line">  <span class="comment">//jsonMessage must be JSON-parsable</span></span><br><span class="line">  <span class="attr">sendJsonMessage</span>: <span class="function">(<span class="params">jsonMessage: JsonValue, keep: <span class="built_in">boolean</span> = <span class="literal">true</span></span>) =&gt;</span> <span class="built_in">void</span>,</span><br><span class="line">  <span class="comment">//null before first received message</span></span><br><span class="line">  <span class="attr">lastMessage</span>: <span class="title class_">WebSocketEventMap</span>[<span class="string">&#x27;message&#x27;</span>] | <span class="literal">null</span>,</span><br><span class="line">  <span class="comment">//null before first received message. If message.data is not JSON parsable, then this will be a static empty object</span></span><br><span class="line">  <span class="attr">lastJsonMessage</span>: <span class="title class_">JsonValue</span> | <span class="literal">null</span>,</span><br><span class="line">  <span class="comment">// -1 if uninstantiated, otherwise follows WebSocket readyState mapping: 0: &#x27;Connecting&#x27;, 1 &#x27;OPEN&#x27;, 2: &#x27;CLOSING&#x27;, 3: &#x27;CLOSED&#x27;</span></span><br><span class="line">  <span class="attr">readyState</span>: <span class="built_in">number</span>,</span><br><span class="line">  <span class="comment">// If using a shared websocket, return value will be a proxy-wrapped websocket, with certain properties/methods protected</span></span><br><span class="line">  <span class="attr">getWebSocket</span>: <span class="function">() =&gt;</span> (<span class="title class_">WebSocketLike</span> | <span class="literal">null</span>),</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>ä½¿ç”¨<code>react-use-websocket</code> æ”¹å†™åçš„ä»£ç å¦‚ä¸‹ï¼š</p><div class="highlight-container" data-rel="Tsx"><figure class="iseeu highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; useEffect, useMemo, useRef, useState &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span></span><br><span class="line"><span class="keyword">import</span> useWebSocket <span class="keyword">from</span> <span class="string">&#x27;react-use-websocket&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;./App.css&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">WebSocketLike</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;react-use-websocket/dist/lib/types&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">App</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> ws = useRef&lt;<span class="title class_">WebSocketLike</span> | <span class="literal">null</span>&gt;(<span class="literal">null</span>);</span><br><span class="line">  <span class="keyword">const</span> senderRef = useRef&lt;<span class="title class_">HTMLInputElement</span>&gt;(<span class="literal">null</span>);</span><br><span class="line">  <span class="keyword">const</span> [shouldConnect, setShouldConnect] = useState&lt;<span class="built_in">boolean</span>&gt;(<span class="literal">false</span>);</span><br><span class="line">  <span class="keyword">const</span> [host, setHost] = useState&lt;<span class="built_in">string</span>&gt;(<span class="string">&#x27;localhost:4567&#x27;</span>);</span><br><span class="line">  <span class="keyword">const</span> [messages, setMessages] = useState&lt;&#123;</span><br><span class="line">    <span class="attr">category</span>: <span class="string">&#x27;message&#x27;</span> | <span class="string">&#x27;error&#x27;</span> | <span class="string">&#x27;info&#x27;</span>,</span><br><span class="line">    <span class="attr">message</span>: <span class="built_in">string</span></span><br><span class="line">  &#125;[]&gt;([]);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> &#123;</span><br><span class="line">    sendMessage,</span><br><span class="line">    lastMessage,</span><br><span class="line">    readyState,</span><br><span class="line">    getWebSocket,</span><br><span class="line">  &#125; = <span class="title function_">useWebSocket</span>(<span class="string">&quot;ws://&quot;</span>+host, &#123;</span><br><span class="line">    <span class="attr">onOpen</span>: <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      ws.<span class="property">current</span> = <span class="title function_">getWebSocket</span>();</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">shouldReconnect</span>: <span class="function">() =&gt;</span> shouldConnect,</span><br><span class="line">  &#125;, shouldConnect);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> connected = readyState === <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (lastMessage) &#123;</span><br><span class="line">      <span class="comment">// eslint-disable-next-line @typescript-eslint/no-unsafe-assignment</span></span><br><span class="line">      <span class="keyword">const</span> &#123; data &#125; = lastMessage</span><br><span class="line">      <span class="title function_">setMessages</span>(<span class="function">(<span class="params">prev</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> [...prev, &#123; <span class="attr">category</span>: <span class="string">&#x27;message&#x27;</span>, <span class="attr">message</span>: data <span class="keyword">as</span> <span class="built_in">string</span> &#125;]</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;, [lastMessage])</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> texts = <span class="title function_">useMemo</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> messages.<span class="title function_">map</span>(<span class="function">(<span class="params">&#123; category, message &#125;, index</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&#123;category&#125;</span> <span class="attr">key</span>=<span class="string">&#123;index&#125;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        &#123;`[$&#123;category.toUpperCase()&#125;] $&#123;message&#125;`&#125;</span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;, [messages])</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">handleConnect</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">    <span class="title function_">setShouldConnect</span>(<span class="literal">true</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">handleDisconnect</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (ws.<span class="property">current</span>) &#123;</span><br><span class="line">      ws.<span class="property">current</span>.<span class="title function_">close</span>();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="title function_">handleDisconnect</span>();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;, [])</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&#x27;flex-container&#x27;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">value</span>=<span class="string">&#123;host&#125;</span> <span class="attr">onChange</span>=<span class="string">&#123;(e)</span> =&gt;</span> setHost(e.target.value)&#125; /&gt;</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">button</span> <span class="attr">disabled</span>=<span class="string">&#123;connected&#125;</span> <span class="attr">onClick</span>=<span class="string">&#123;handleConnect&#125;</span>&gt;</span>Connect<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">button</span> <span class="attr">disabled</span>=<span class="string">&#123;!connected&#125;</span> <span class="attr">onClick</span>=<span class="string">&#123;handleDisconnect&#125;</span>&gt;</span>Disconnect<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      &#123;</span></span><br><span class="line"><span class="language-xml">        connected &amp;&amp;</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&#x27;flex-container sender&#x27;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">input</span> <span class="attr">ref</span>=<span class="string">&#123;senderRef&#125;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;()</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-xml">              if (senderRef.current) &#123;</span></span><br><span class="line"><span class="language-xml">                sendMessage(senderRef.current.value);</span></span><br><span class="line"><span class="language-xml">                senderRef.current.value = &#x27;&#x27;;</span></span><br><span class="line"><span class="language-xml">              &#125;</span></span><br><span class="line"><span class="language-xml">            &#125;&#125;&gt;Send<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      &#125;      </span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&#x27;log-div&#x27;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        &#123;texts&#125;</span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  )</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title class_">App</span></span><br><span class="line"></span><br></pre></td></tr></table></figure></div><p>å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬ä½¿ç”¨äº†<code>react-use-websocket</code> åç”±äºç”¨å…¶æš´éœ²çš„å±æ€§è¿›è¡Œäº†é€»è¾‘é‡å†™ï¼ŒåŒ…æ‹¬ä½¿ç”¨<code>useEffect</code> æ¥æ›´æ–°æ¶ˆæ¯é˜Ÿåˆ—ã€ç›´æ¥ä½¿ç”¨<code>sendMessage()</code> æ¥å‘é€æ¶ˆæ¯ä»¥åŠç›´æ¥ä½¿ç”¨<code>readyState</code> æ¥åˆ¤æ–­è¿æ¥çŠ¶æ€ã€‚ç›¸è¾ƒäºä¹‹å‰çš„å®ç°ï¼Œå°è£…åçš„ä»£ç æ˜¾ç„¶å‡å°äº†é‡å¤ä»£ç é‡ã€‚</p><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œç”±äºè¯¥Hookå°†WebSocketå®ä¾‹å°è£…åœ¨äº†å†…éƒ¨ï¼Œå¤–éƒ¨é‡‡ç”¨çŠ¶æ€é©±åŠ¨çš„å‡½æ•°å¼å½¢å¼ï¼Œå› æ­¤æ— æ³•é€šè¿‡æ–°å»ºå®ä¾‹çš„æ–¹å¼å¯¹åŒä¸€WSåœ°å€è¿›è¡Œæ–­å¼€å’Œé‡è¿ï¼ˆå³æ‰‹åŠ¨æ§åˆ¶è¿æ¥çŠ¶æ€ï¼‰ï¼Œåªèƒ½ä¾èµ–ä»¥ä¸‹ä¸¤ç§æ–¹å¼ï¼š</p><ul><li>å°†<code>shouldConnect</code> å’Œ<code>shouldReconnect</code> ç»‘å®šåˆ°ä¸€ä¸ªå¤–éƒ¨çš„<code>connect</code> çŠ¶æ€ä¸­ï¼Œ<strong>ç­‰å¾…é‡è¿æ¥é‡æ–°å»ºç«‹è¿æ¥</strong>ï¼ˆä¸Šé¢ä»£ç çš„æ–¹æ³•ï¼‰</li><li>é€šè¿‡åˆ·æ–°è¾“å…¥Hookçš„<code>url</code> å‚æ•°å¯ä»¥åšåˆ°<strong>ç«‹åˆ»æ–°å»º<code>WebSocket</code>å®ä¾‹å¹¶é‡è¿ï¼ˆæ¨èï¼‰</strong>ï¼Œå®è·µä¸­å¯ä»¥åœ¨é‡è¿åç«‹åˆ»æ¸…ç©ºçŠ¶æ€ï¼Œç­‰å¾…ç”¨æˆ·é‡æ–°è¾“å…¥</li><li>å¦‚æœä¸éœ€è¦ç”¨æˆ·æ§åˆ¶è¿æ¥ï¼Œåå°ç»´æŠ¤è¿æ¥çš„è¯å°±ä¸éœ€è¦å°†<code>connect</code> æ“ä½œæš´éœ²ç»™ç”¨æˆ·</li></ul><h4 id="ä½¿ç”¨WebSocketä¼ è¾“æ–‡ä»¶">ä½¿ç”¨WebSocketä¼ è¾“æ–‡ä»¶</h4><p>WebSocketä¸­ä½¿ç”¨ArrayBufferä¼ è¾“æ–‡ä»¶ï¼Œåœ¨<code>react-use-websocket</code>ä¸­ç›´æ¥å°†æ–‡ä»¶ç”¨<code>sendMessage()</code> ä¼ è¾“å‡ºå»å³å¯ï¼Œ<code>ws</code> æ¥æ”¶åˆ°çš„å‚æ•°ä¸­<code>isBin</code> å°±æ˜¯<code>true</code> ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img lazyload src="/images/loading.svg" data-src="https://picgo-1308055782.cos.ap-chengdu.myqcloud.com/picgo-core/2023/07/20230709002953.png" alt=""></p><p>å› æ­¤ï¼Œä½¿ç”¨ArrayBufferä¼ è¾“æ–‡ä»¶çš„æ–¹æ¡ˆæœ‰ä¸‹ï¼š</p><ul><li>ç›´æ¥ä¼ è¾“æ–‡ä»¶ï¼ŒWebSocketå¯ä»¥æ¥æ”¶<code>Blob</code> å¯¹è±¡ï¼ˆ<code>File</code> æ˜¯<code>Blob</code> çš„å­ç±»ï¼‰è¿›è¡Œä¼ è¾“</li><li>ä½¿ç”¨JSONåŒ…è£…åä¼ è¾“ï¼Œè¿™æ—¶éœ€è¦å°†æ–‡ä»¶æ‰‹åŠ¨è¯»å–ä¸ºArrayBufferä¼ è¾“</li><li>é«˜çº§æ“ä½œï¼š<strong>åœ¨æœåŠ¡ç«¯è¯»å–å·²ä¼ è¾“å­—èŠ‚æ•°å’Œæ€»é•¿åº¦ï¼Œè¿”å›ä¼ è¾“ç™¾åˆ†æ¯”</strong></li></ul><h2 id="socket-io-åº“"><a class="link" target="_blank" rel="noopener" href="http://socket.io">socket.io <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a> åº“</h2><blockquote><p>ğŸš¦<a class="link" target="_blank" rel="noopener" href="http://Socket.IO" title="Socket.IO">Socket.IO <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a> <strong>ä¸æ˜¯</strong> WebSocketå®ç°ã€‚å°½ç®¡å®ƒ<strong>å°½å¯èƒ½ä½¿ç”¨ WebSocket ä½œä¸ºä¼ è¾“åè®®</strong>ï¼Œä½†å®ƒä¸€æ–¹é¢<strong>å¯èƒ½å›é€€åˆ°å…¶ä»–ä¼ è¾“æ–¹å¼ï¼ˆå¦‚Ajaxè½®è¯¢ï¼‰</strong>ï¼Œå¦ä¸€æ–¹é¢å…¶<strong>æ¯æ¡æ¶ˆæ¯éƒ½è¢«é™„ä¸Šäº†é¢å¤–çš„æ•°æ®æ¥å®ç°è‡ªèº«é€»è¾‘ï¼Œå¦‚è½®è¯¢å›é€€ã€è‡ªåŠ¨é‡è¿ç­‰</strong>ã€‚<br>è¿™å°±æ˜¯<strong>ä¸ºä»€ä¹ˆ WebSocket å®¢æˆ·ç«¯å°†æ— æ³•æˆåŠŸè¿æ¥åˆ° <strong><a target="_blank" rel="noopener" href="http://Socket.IO" title="Socket.IO"><strong>Socket.IO</strong></a></strong> æœåŠ¡å™¨ï¼Œè€Œ <strong><a target="_blank" rel="noopener" href="http://Socket.IO" title="Socket.IO"><strong>Socket.IO</strong></a></strong> å®¢æˆ·ç«¯ä¹Ÿå°†æ— æ³•è¿æ¥åˆ°æ™®é€š WebSocket æœåŠ¡å™¨</strong>ï¼Œè™½ç„¶Socket.ioçš„ä¼ è¾“åè®®ä½¿ç”¨äº†WebSocketï¼Œä½†å®ƒä»¬åœ¨æ¥å£ä¸Šå¹¶ä¸æ˜¯å…¼å®¹çš„ã€‚</p></blockquote><p><a class="link" target="_blank" rel="noopener" href="http://Socket.IO" title="Socket.IO">Socket.IO <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a> æ˜¯ä¸€ä¸ªå¤šè¯­è¨€ã€è·¨å¹³å°çš„åº“ï¼Œå¯ä»¥åœ¨å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´å®ç° <strong>ä½å»¶è¿Ÿ</strong>, <strong>åŒå‘</strong> å’Œ <strong>åŸºäºäº‹ä»¶çš„</strong> é€šä¿¡ã€‚é€šå¸¸æƒ…å†µä¸‹ï¼Œå®ƒå»ºç«‹åœ¨ <a class="link" target="_blank" rel="noopener" href="https://fr.wikipedia.org/wiki/WebSocket" title="WebSocket">WebSocket <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a> åè®®ä¹‹ä¸Šï¼Œå¹¶æä¾›é¢å¤–çš„ä¿è¯ï¼Œä¾‹å¦‚å›é€€åˆ° HTTP é•¿è½®è¯¢æˆ–è‡ªåŠ¨é‡æ–°è¿æ¥ã€‚å®ƒæä¾›ä»¥ä¸‹é¢å¤–ç‰¹æ€§ï¼š</p><ul><li>HTTP é•¿è½®è¯¢å›é€€ï¼šå¦‚æœæ— æ³•å»ºç«‹ WebSocket è¿æ¥ï¼Œè¿æ¥å°†å›é€€åˆ° HTTP é•¿è½®è¯¢</li><li>è‡ªåŠ¨é‡æ–°è¿æ¥ï¼š<a class="link" target="_blank" rel="noopener" href="http://Socket.IO" title="Socket.IO">Socket.IO <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a> åŒ…å«ä¸€ä¸ª<strong>å¿ƒè·³æœºåˆ¶</strong>ï¼Œå®ƒä¼šå®šæœŸæ£€æŸ¥è¿æ¥çš„çŠ¶æ€</li><li>æ•°æ®åŒ…ç¼“å†²ï¼šå½“å®¢æˆ·ç«¯æ–­å¼€è¿æ¥æ—¶ï¼Œæ•°æ®åŒ…ä¼šè‡ªåŠ¨ç¼“å†²ï¼Œå¹¶åœ¨é‡æ–°è¿æ¥æ—¶å‘é€</li><li>å¹¿æ’­å’Œå¤šè·¯å¤ç”¨<ul><li>æœåŠ¡å™¨ç«¯å¯ä»¥é€šè¿‡<strong>å¹¿æ’­å‘æ‰€æœ‰å®¢æˆ·ç«¯æˆ–ç‰¹å®šå­é›†</strong>å‘é€ä¿¡æ¯</li><li>å¤šè·¯å¤ç”¨ï¼šé€šè¿‡<strong>å‘½åç©ºé—´</strong>æœºåˆ¶ä½¿ç”¨<strong>å•ä¸ªè¿æ¥æ‹†åˆ†å‡ºå¤šä¸ªä¿¡é“</strong><img lazyload src="/images/loading.svg" data-src="https://picgo-1308055782.cos.ap-chengdu.myqcloud.com/picgo-core/2023/07/20230709002958.png" alt=""></li></ul></li></ul><h3 id="å·¥ä½œåŸç†">å·¥ä½œåŸç†</h3><p>socket.ioé»˜è®¤å·¥ä½œåœ¨WebSocketä¸Šï¼Œåœ¨è½®è¯¢æ¨¡å¼ä¸­åˆ™å›é€€åˆ°HTTPï¼Œä½†å…¶æŠ¥æ–‡å†…å®¹æ˜¯ä¸€è‡´çš„ã€‚socket.ioé€šè¿‡åœ¨æŠ¥æ–‡è´Ÿè½½ä¸­é™„ä¸Šé¢å¤–ä¿¡æ¯æ¥ç¡®ä¿è‡ªèº«é¢å¤–åŠŸèƒ½çš„å®ç°ã€‚</p><p>å¦‚<code>socket.emit(&quot;hello&quot;, &quot;world&quot;)</code> å°†ä½œä¸ºå•ä¸ª WebSocket å¸§å‘é€ï¼Œå…¶ä¸­åŒ…å«<code>42[&quot;hello&quot;,&quot;world&quot;]</code>ï¼š</p><ul><li><code>4</code> æ˜¯ <a class="link" target="_blank" rel="noopener" href="http://Engine.IO" title="Engine.IO">Engine.IO <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a> â€œæ¶ˆæ¯â€æ•°æ®åŒ…ç±»å‹</li><li><code>2</code> æ˜¯ <a class="link" target="_blank" rel="noopener" href="http://Socket.IO" title="Socket.IO">Socket.IO <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a> â€œæ¶ˆæ¯â€æ•°æ®åŒ…ç±»å‹</li><li><code>[&quot;hello&quot;,&quot;world&quot;]</code>æ˜¯å‚æ•°æ•°ç»„è¢«<code>JSON.stringify()</code>è¿‡çš„ç‰ˆæœ¬</li></ul><p>ä½ å¯èƒ½æ³¨æ„åˆ°äº†ä¸Šé¢æœ‰engine.ioå’Œsocket.ioä¸¤ç§ä¸åŒçš„æ•°æ®åŒ…ç±»å‹æ ‡è¯†ç¬¦ï¼Œè¿™<strong><a class="link" target="_blank" rel="noopener" href="http://xn--Socket-2e8i713gsgf.io">å¯¹åº”äº†Socket.io <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a> ä¸¤ä¸ªä¸åŒçš„å±‚</strong>ï¼š</p><ul><li>åº•å±‚é€šé“ <a class="link" target="_blank" rel="noopener" href="http://Engine.IO">Engine.IO <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a>ï¼š<strong>è´Ÿè´£å»ºç«‹æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯ä¹‹é—´çš„ä½çº§è¿æ¥</strong>ï¼Œå¦‚WebSocketè¿æ¥ã€è½®è¯¢å›é€€ã€æ–­çº¿æ£€æµ‹ï¼ˆå¿ƒè·³æœºåˆ¶ï¼‰ç­‰ï¼Œ<strong>å‘ä¸Šæä¾›ä¸€ä¸ªå…¨åŒå·¥è¿æ¥çš„æŠ½è±¡</strong><ul><li><strong>é»˜è®¤ä½¿ç”¨HTTPé•¿è½®è¯¢å»ºç«‹è¿æ¥ï¼Œåç»­å°è¯•å‡çº§åè®®ä¸ºWebSocket</strong><ul><li>HTTP é•¿è½®è¯¢ï¼šç”±è¿ç»­çš„ HTTP è¯·æ±‚ç»„æˆï¼ŒWebSocketçš„å›é€€ç­–ç•¥<ul><li>é•¿æ—¶é—´è¿è¡Œçš„ <code>GET</code> è¯·æ±‚ï¼Œç”¨äºä»æœåŠ¡å™¨æ¥æ”¶æ•°æ®</li><li>çŸ­æ—¶ <code>POST</code> è¯·æ±‚ï¼Œç”¨äºå‘æœåŠ¡å™¨å‘é€æ•°æ®</li></ul></li><li>WebSocket ä¼ è¾“ï¼šç”±WebSocket è¿æ¥ç»„æˆï¼Œå®ƒåœ¨æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯ä¹‹é—´æä¾›åŒå‘å’Œä½å»¶è¿Ÿçš„é€šä¿¡é€šé“</li></ul></li><li>å‘ä¸‹å®ç°å¯äº¤ä»˜ä¿è¯ï¼Œ<strong>å‘ä¸Šå±è”½é€šè®¯å®ç°ç»†èŠ‚ï¼Œå¹¶æä¾›ä¸Šå±‚åŠŸèƒ½æ‰€éœ€çš„API</strong>ï¼ˆå¦‚æ‹“å±•çš„äº‹ä»¶ä½“ç³»ï¼‰</li></ul></li><li><a class="link" target="_blank" rel="noopener" href="http://xn--Socket-9o7ik76gyqa5476a.IO">ä¸Šå±‚å°è£…Socket.IO <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a>ï¼šåœ¨Engine.IOå»ºç«‹è¿æ¥åæ·»åŠ <strong>é¢å‘ç”¨æˆ·çš„é™„åŠ åŠŸèƒ½</strong>ï¼Œå¦‚è‡ªåŠ¨é‡è¿ã€å¤šè·¯å¤ç”¨ç­‰</li></ul><h4 id="Socket-å®ä¾‹"><code>Socket</code> å®ä¾‹</h4><p>è¿™é‡Œçš„Socketæ¦‚å¿µå’ŒWebSocketç±»ä¼¼ï¼Œå¯¹åº”ä¸€ä¸ªè¿æ¥ï¼Œå…¶å…·æœ‰ä»¥ä¸‹é¢å¤–å±æ€§ï¼š</p><ul><li><code>id</code> å±æ€§ï¼šæ¯ä¸ªæ–°è¿æ¥éƒ½åˆ†é…æœ‰ä¸€ä¸ªéšæœºçš„ 20 ä¸ªå­—ç¬¦çš„æ ‡è¯†ç¬¦</li><li><code>handshake</code> å±æ€§ï¼šæ¡æ‰‹ä¿¡æ¯</li><li><code>conn</code> å±æ€§ï¼šåº•å±‚è¿æ¥ä¿¡æ¯</li></ul><h5 id="æˆ¿é—´">æˆ¿é—´</h5><p>æˆ¿é—´æ˜¯åœ¨<strong>æœåŠ¡å™¨ç«¯å¯è§çš„å®¢æˆ·ç«¯çš„é›†åˆ</strong>ï¼Œå®ƒåŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ªå®¢æˆ·ç«¯ã€‚</p><ul><li>æ¯ä¸ªSocketåˆ›å»ºåä¼šåŠ å…¥ç”±<strong>å…¶è‡ªå·±çš„ id æ ‡è¯†çš„æˆ¿é—´</strong>ï¼Œè¿™æ„å‘³ç€æ‚¨å¯ä»¥å°†å…¶ç”¨äºç§äººæ¶ˆæ¯ä¼ é€’</li><li><code>socket.rooms()</code> å¯ä»¥æŸ¥çœ‹å½“å‰Socketæ‰€åœ¨æˆ¿é—´çš„é›†åˆ</li><li><code>socket.join(roomName: string)</code> å¯ä»¥ä½¿socketåŠ å…¥æŸä¸ªæˆ¿é—´</li><li><code>io.to(room).emit(event, ...args)</code> å¯ä»¥<strong>å‘æˆ¿é—´å†…æ‰€æœ‰å®¢æˆ·ç«¯å¹¿æ’­äº‹ä»¶</strong><ul><li><code>to()</code> æ”¯æŒçº§è”ï¼ŒåŒæ—¶å‘å¤šä¸ªæˆ¿é—´å‘é€</li><li>è‹¥ä»<code>socket</code> å‘é€å¹¿æ’­ï¼Œåˆ™é™¤äº†å‘é€è€…å¤–æˆ¿é—´å†…æ‰€æœ‰å®¢æˆ·ç«¯éƒ½ä¼šæ”¶åˆ°å¹¿æ’­</li></ul></li></ul><h5 id="ä¸­é—´ä»¶">ä¸­é—´ä»¶</h5><p>ä¸­é—´ä»¶å‡½æ•°æ˜¯ä¸ºæ¯ä¸ªä¼ å…¥è¿æ¥æ‰§è¡Œçš„å‡½æ•°ï¼ŒSocket.ioé‡Œçš„ä¸­é—´ä»¶å’Œå…¶ä»–åœ°æ–¹çš„ä¸­é—´ä»¶å«ä¹‰æ˜¯ç›¸åŒçš„ï¼Œé€šå¸¸ç”¨äºç™»å½•æ£€æµ‹ç­‰é¢†åŸŸã€‚</p><h4 id="æ¶ˆæ¯ç±»å‹ä¸äº‹ä»¶å¤„ç†">æ¶ˆæ¯ç±»å‹ä¸äº‹ä»¶å¤„ç†</h4><blockquote><p><a class="link" target="_blank" rel="noopener" href="http://Socket.IO" title="Socket.IO">Socket.IO <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a> API çš„çµæ„Ÿæ¥è‡ª Node.js EventEmitterï¼Œè¿™æ„å‘³ç€æ‚¨å¯ä»¥åœ¨ä¸€ä¾§å‘å‡ºäº‹ä»¶å¹¶åœ¨å¦ä¸€ä¾§æ³¨å†Œä¾¦å¬å™¨</p></blockquote><p>å’Œæ™®é€šçš„WebSocketä¸€æ ·ï¼ŒSocket.ioä¹Ÿæ˜¯<strong>åŸºäºäº‹ä»¶é©±åŠ¨çš„åŒå·¥é€šè®¯</strong></p><ul><li><code>io.on('connection', (socket) â‡’ &#123;...&#125;)</code> æ˜¯æœåŠ¡ç«¯<strong>ä¸€åˆ‡äº‹ä»¶çš„èµ·ç‚¹</strong>ï¼Œéœ€è¦åœ¨å›è°ƒä¸­ç»™æ¯ä¸ªsocketç»‘å®šäº‹ä»¶</li><li><code>socket.on(event: string, callback: (...args) â‡’ void)</code> æ˜¯<strong>å¯¹Socketè¿æ¥æ³¨å†Œäº‹ä»¶ç›‘å¬</strong>çš„æ–¹æ³•<ul><li><code>socket.once()</code> æ˜¯ç­¾åå’Œ<code>on()</code> ç›¸åŒçš„<strong>ä¸€æ¬¡æ€§ç›‘å¬å‡½æ•°</strong></li><li><code>socket.onAny(listener)</code> å¯ç”¨äº<strong>ç›‘å¬ä»»æ„äº‹ä»¶</strong></li><li><code>disconnect</code> å’Œ <code>disconnecting</code> ï¼šåœ¨æœåŠ¡ç«¯å‘å‡ºçš„ç‰¹æ®Šäº‹ä»¶ï¼ŒSocket å®ä¾‹åœ¨æ–­å¼€è¿æ¥æ—¶è§¦å‘ï¼Œ<code>payload</code> ä¸ºæ–­å¼€åŸå› </li><li><code>event</code> æ˜¯<strong>å¯ä»¥è‡ªå®šä¹‰çš„</strong>ï¼Œåªè¦ä¸è¦†ç›–ä»»ä½•ç°æœ‰äº‹ä»¶å°±å¯ä»¥æ˜¯ä»»ä½•ç±»å‹çš„å­—æ®µï¼Œè¿™<strong>å¯¹åº”äº†åŸç‰ˆWebSocketçš„<code>type</code>å­—æ®µ</strong>ï¼Œä½†ä¸åŒä¹‹å¤„æ˜¯åŸç‰ˆWebSocketä¸­åªèƒ½ä½¿ç”¨<code>send()</code> æ–¹æ³•ï¼Œ<code>type</code> å›ºå®šä¸º<code>message</code> ï¼Œä½†<strong>è¿™é‡Œæ˜¯å¯ä»¥å®Œå…¨è‡ªå®šä¹‰çš„</strong></li></ul></li><li><code>socket.off(event: string)</code> ç”¨äºç§»é™¤æŒ‡å®šç›‘å¬å™¨</li><li><code>socket.emit(event: string, ...args: any)</code> æ˜¯<strong>å‘å¯¹æ–¹å‘é€äº‹ä»¶</strong>çš„æ–¹æ³•<ul><li><code>socket.send(..args)</code> æ–¹æ³•ä»æ˜¯æ”¯æŒçš„ï¼Œå°†å‘é€ä¸€ä¸ªé»˜è®¤çš„<code>message</code> äº‹ä»¶</li><li>å¯ä»¥å‘é€ä»»æ„æ•°é‡çš„å‚æ•°ï¼Œå¹¶ä¸”<strong>æ”¯æŒæ‰€æœ‰å¯åºåˆ—åŒ–çš„æ•°æ®ç»“æ„</strong>ï¼Œ<strong>åŒ…æ‹¬åƒBuffer æˆ– TypedArrayè¿™æ ·çš„äºŒè¿›åˆ¶å¯¹è±¡</strong>ï¼Œå¹¶ä¸”<strong>æ— éœ€<code>JSON.stringify()</code>ï¼Œå› ä¸ºå®ƒä¼šä¸ºæ‚¨å®Œæˆ</strong></li><li>å¯ä»¥åœ¨<code>emit</code> ä¸­æ·»åŠ å›è°ƒï¼Œåªéœ€è¦æŠŠæœ€åä¸€ä¸ªå‚æ•°è®¾ä¸ºå›è°ƒå‡½æ•°ï¼Œåœ¨æœåŠ¡ç«¯è¿›è¡Œè°ƒç”¨å³å¯</li></ul></li></ul><h4 id="å¹¿æ’­äº‹ä»¶">å¹¿æ’­äº‹ä»¶</h4><ul><li><code>socket.broadcast.emit(event, ...args)</code> ä¼šå‘<strong>é™¤å‘é€è€…å¤–çš„æ‰€æœ‰å®¢æˆ·ç«¯</strong>å‘é€æ¶ˆæ¯</li></ul><h4 id="å‘½åç©ºé—´å’Œå¤šè·¯å¤ç”¨">å‘½åç©ºé—´å’Œå¤šè·¯å¤ç”¨</h4><blockquote><p>ğŸš¦å¾…å®Œæˆ</p></blockquote><h3 id="Node-js-å®è·µ-2">Node.js å®è·µ</h3><h4 id="åˆ›å»ºåç«¯æœåŠ¡å™¨">åˆ›å»ºåç«¯æœåŠ¡å™¨</h4><div class="highlight-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Server</span> &#125; <span class="keyword">from</span> <span class="string">&quot;socket.io&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> io = <span class="keyword">new</span> <span class="title class_">Server</span>(&#123;</span><br><span class="line">  <span class="attr">cors</span>: <span class="string">&#x27;http://127.0.0.1:5173/&#x27;</span>,</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> progress = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">io.<span class="title function_">on</span>(<span class="string">&#x27;connection&#x27;</span>, <span class="function">(<span class="params">socket</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`[Server] Connection established with <span class="subst">$&#123;socket.id&#125;</span>`</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ¨¡æ‹Ÿè¿›åº¦</span></span><br><span class="line">  <span class="keyword">const</span> timer = <span class="built_in">setInterval</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (progress &lt; <span class="number">100</span>) &#123;</span><br><span class="line">      socket.<span class="title function_">emit</span>(<span class="string">&quot;progress&quot;</span>, progress);</span><br><span class="line">      socket.<span class="title function_">send</span>(<span class="string">`<span class="subst">$&#123;progress&#125;</span>% è¿™æ˜¯ä¸€æ¡æ¨¡æ‹Ÿæ—¥å¿—`</span>);</span><br><span class="line">      progress++;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      socket.<span class="title function_">emit</span>(<span class="string">&quot;progress&quot;</span>, progress);</span><br><span class="line">      socket.<span class="title function_">send</span>(<span class="string">&quot;Done&quot;</span>);</span><br><span class="line">      progress = <span class="number">0</span>;</span><br><span class="line">      <span class="built_in">clearInterval</span>(timer);</span><br><span class="line">      socket.<span class="title function_">disconnect</span>();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;, <span class="number">100</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// åŸºç¡€å›å£°</span></span><br><span class="line">  socket.<span class="title function_">on</span>(<span class="string">&#x27;message&#x27;</span>, <span class="function">(<span class="params">data</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`[Message] <span class="subst">$&#123;data&#125;</span>`</span>);</span><br><span class="line">    socket.<span class="title function_">send</span>(<span class="string">`[Echo] You sent -&gt; <span class="subst">$&#123;data&#125;</span>`</span>);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ–­å¼€è¿æ¥</span></span><br><span class="line">  socket.<span class="title function_">on</span>(<span class="string">&#x27;disconnect&#x27;</span>, <span class="function">(<span class="params">reason</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">clearInterval</span>(timer);</span><br><span class="line">    progress = <span class="number">0</span>;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`[Server] Connection with <span class="subst">$&#123;socket.id&#125;</span> closed with <span class="subst">$&#123;reason&#125;</span>`</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">io.<span class="title function_">listen</span>(<span class="number">4567</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure></div><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­æˆ‘ä½¿ç”¨è‡ªå®šä¹‰äº‹ä»¶<code>progress</code> æ¨¡æ‹Ÿäº†ä¸€ä¸ªåå°è¿›ç¨‹å‘å‰ç«¯è¾“å‡ºæ—¥å¿—å’Œè¿›åº¦çš„è¿‡ç¨‹ã€‚</p><blockquote><p>ğŸŒŸéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨å‰åç«¯åˆ†ç¦»çš„æƒ…å†µä¸‹æˆ‘ä»¬éœ€è¦æ‰‹åŠ¨æŒ‡å®šè·¨åŸŸï¼Œå°±åƒä¸Šé¢çš„<code>cors: 'http://127.0.0.1:5173/',</code> ä¸€æ ·</p></blockquote><h4 id="ä¿®æ”¹å‰ç«¯é¡µé¢">ä¿®æ”¹å‰ç«¯é¡µé¢</h4><p>è¿™é‡Œæˆ‘ä»¬æ²¿ç”¨ä¸Šä¸€ä¸ªWebSocketçš„ä¾‹å­ï¼Œå…ˆå®‰è£…ä¾èµ– <code>pnpm add socket.io-client</code> ã€‚</p><p>ç›´æ¥æŠ½è±¡å‡ºä¸€ä¸ª<code>useSocket</code> Hookè¿›è¡Œå°è£…ï¼š</p><div class="highlight-container" data-rel="Tsx"><figure class="iseeu highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// useSocket.ts</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* eslint-disable react-hooks/exhaustive-deps */</span></span><br><span class="line"><span class="keyword">import</span> &#123; useEffect, useRef, useState &#125; <span class="keyword">from</span> <span class="string">&quot;react&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; io &#125; <span class="keyword">from</span> <span class="string">&quot;socket.io-client&quot;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">useSocket</span>(<span class="params">url: <span class="built_in">string</span>, autoConnect=<span class="literal">false</span></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> socket = <span class="title function_">useRef</span>(<span class="title function_">io</span>(url, &#123; autoConnect &#125;));</span><br><span class="line">  <span class="keyword">const</span> [isConnected, setIsConnected] = <span class="title function_">useState</span>(socket.<span class="property">current</span>.<span class="property">connected</span>);</span><br><span class="line">  <span class="keyword">const</span> [latestMessage, setLatestMessage] = useState&lt;<span class="built_in">unknown</span>&gt;(<span class="literal">null</span>);</span><br><span class="line">  <span class="keyword">const</span> [progress, setProgress] = useState&lt;<span class="built_in">number</span>&gt;(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">  <span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    socket.<span class="property">current</span>.<span class="title function_">on</span>(<span class="string">&quot;connect&quot;</span>, <span class="function">() =&gt;</span> &#123; </span><br><span class="line">      <span class="title function_">setIsConnected</span>(<span class="literal">true</span>);</span><br><span class="line">      <span class="title function_">setLatestMessage</span>(<span class="string">&#x27;Connected!&#x27;</span>)</span><br><span class="line">    &#125;);</span><br><span class="line">    socket.<span class="property">current</span>.<span class="title function_">on</span>(<span class="string">&quot;disconnect&quot;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="title function_">setIsConnected</span>(<span class="literal">false</span>);</span><br><span class="line">      <span class="title function_">alert</span>(<span class="string">&#x27;Disconnected!&#x27;</span>)</span><br><span class="line">    &#125;);</span><br><span class="line">    socket.<span class="property">current</span>.<span class="title function_">on</span>(<span class="string">&quot;message&quot;</span>, <span class="function">(<span class="params">data</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="title function_">setLatestMessage</span>(<span class="string">`<span class="subst">$&#123;<span class="built_in">Date</span>.now()&#125;</span>: <span class="subst">$&#123;data <span class="keyword">as</span> <span class="built_in">string</span>&#125;</span>`</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    socket.<span class="property">current</span>.<span class="title function_">on</span>(<span class="string">&quot;progress&quot;</span>, <span class="function">(<span class="params">progress: <span class="built_in">number</span></span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="title function_">setProgress</span>(progress);</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      socket.<span class="property">current</span>.<span class="title function_">off</span>(<span class="string">&quot;connect&quot;</span>);</span><br><span class="line">      socket.<span class="property">current</span>.<span class="title function_">off</span>(<span class="string">&quot;disconnect&quot;</span>);</span><br><span class="line">      socket.<span class="property">current</span>.<span class="title function_">off</span>(<span class="string">&quot;message&quot;</span>);</span><br><span class="line">      socket.<span class="property">current</span>.<span class="title function_">off</span>(<span class="string">&quot;progress&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;, [])</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">handleSendMessage</span> = (<span class="params">message: <span class="built_in">string</span></span>) =&gt; &#123; </span><br><span class="line">    socket.<span class="property">current</span>.<span class="title function_">send</span>(message);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123; isConnected, latestMessage, progress, <span class="attr">sendMessage</span>: handleSendMessage, <span class="attr">socket</span>: socket.<span class="property">current</span> &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// App.tsx</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; useCallback, useEffect, useMemo, useRef, useState &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;./App.css&#x27;</span></span><br><span class="line"><span class="keyword">import</span> useSocket <span class="keyword">from</span> <span class="string">&#x27;./useSocket&#x27;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> inputTypes = [<span class="string">&#x27;text&#x27;</span>, <span class="string">&#x27;file&#x27;</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">App</span>(<span class="params"></span>) &#123;  </span><br><span class="line">  <span class="keyword">const</span> senderRef = useRef&lt;<span class="title class_">HTMLInputElement</span>&gt;(<span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> [inputType, setInputType] = useState&lt;<span class="built_in">string</span>&gt;(inputTypes[<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> [host, setHost] = useState&lt;<span class="built_in">string</span>&gt;(<span class="string">&#x27;localhost:4567&#x27;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> &#123; isConnected, latestMessage, progress, socket, sendMessage &#125; = <span class="title function_">useSocket</span>(<span class="string">&quot;http://&quot;</span> + host);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> [messages, setMessages] = useState&lt;&#123;</span><br><span class="line">    <span class="attr">category</span>: <span class="string">&#x27;message&#x27;</span> | <span class="string">&#x27;error&#x27;</span> | <span class="string">&#x27;info&#x27;</span>,</span><br><span class="line">    <span class="attr">message</span>: <span class="built_in">string</span></span><br><span class="line">  &#125;[]&gt;([]);</span><br><span class="line"></span><br><span class="line">  <span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (latestMessage) &#123;</span><br><span class="line">      <span class="comment">// eslint-disable-next-line @typescript-eslint/no-unsafe-assignment</span></span><br><span class="line">      <span class="title function_">setMessages</span>(<span class="function">(<span class="params">prev</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> [...prev, &#123; <span class="attr">category</span>: <span class="string">&#x27;message&#x27;</span>, <span class="attr">message</span>: latestMessage <span class="keyword">as</span> <span class="built_in">string</span> &#125;]</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;, [latestMessage])</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> texts = <span class="title function_">useMemo</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> messages.<span class="title function_">map</span>(<span class="function">(<span class="params">&#123; category, message &#125;, index</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&#123;category&#125;</span> <span class="attr">key</span>=<span class="string">&#123;index&#125;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        &#123;`[$&#123;category.toUpperCase()&#125;] $&#123;message&#125;`&#125;</span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;, [messages])</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">handleConnect</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">    socket.<span class="title function_">connect</span>();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> handleDisconnect = <span class="title function_">useCallback</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    socket.<span class="title function_">disconnect</span>();</span><br><span class="line">  &#125;, [socket])</span><br><span class="line"></span><br><span class="line">  <span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="title function_">handleDisconnect</span>();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;, [handleDisconnect])</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&#x27;flex-container&#x27;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">value</span>=<span class="string">&#123;host&#125;</span> <span class="attr">onChange</span>=<span class="string">&#123;(e)</span> =&gt;</span> setHost(e.target.value)&#125; /&gt;</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">button</span> <span class="attr">disabled</span>=<span class="string">&#123;isConnected&#125;</span> <span class="attr">onClick</span>=<span class="string">&#123;handleConnect&#125;</span>&gt;</span>Connect<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">button</span> <span class="attr">disabled</span>=<span class="string">&#123;!isConnected&#125;</span> <span class="attr">onClick</span>=<span class="string">&#123;handleDisconnect&#125;</span>&gt;</span>Disconnect<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      &#123;</span></span><br><span class="line"><span class="language-xml">        isConnected &amp;&amp;</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&#x27;flex-container sender&#x27;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">select</span> <span class="attr">value</span>=<span class="string">&#123;inputType&#125;</span> <span class="attr">onChange</span>=<span class="string">&#123;(e)</span> =&gt;</span> &#123;setInputType(e.target.value)&#125;&#125;&gt;</span></span><br><span class="line"><span class="language-xml">              &#123;inputTypes.map((type, index) =&gt; &#123; </span></span><br><span class="line"><span class="language-xml">                return <span class="tag">&lt;<span class="name">option</span> <span class="attr">key</span>=<span class="string">&#123;index&#125;</span> <span class="attr">value</span>=<span class="string">&#123;type&#125;</span>&gt;</span>&#123;type&#125;<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">              &#125;)&#125;</span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">div</span>&gt;</span>&#123;progress&#125;%<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&#123;inputType&#125;</span> <span class="attr">ref</span>=<span class="string">&#123;senderRef&#125;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;()</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-xml">              if (senderRef.current) &#123;</span></span><br><span class="line"><span class="language-xml">                if (inputType === &#x27;text&#x27;) sendMessage(senderRef.current.value);</span></span><br><span class="line"><span class="language-xml">                senderRef.current.value = &#x27;&#x27;;</span></span><br><span class="line"><span class="language-xml">              &#125;</span></span><br><span class="line"><span class="language-xml">            &#125;&#125;&gt;Send<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      &#125;      </span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&#x27;log-div&#x27;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        &#123;texts&#125;</span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  )</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title class_">App</span></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure></div><p>æœ€ç»ˆè¿è¡Œæ•ˆæœå¦‚ä¸‹ï¼š</p><p><img lazyload src="/images/loading.svg" data-src="https://picgo-1308055782.cos.ap-chengdu.myqcloud.com/picgo-core/2023/07/20230709003014.gif" alt=""></p></div><div class="post-copyright-info"><div class="article-copyright-info-container"><ul><li><strong>æ ‡é¢˜:</strong> WebSocket åº”ç”¨ç ”ç©¶</li><li><strong>ä½œè€…:</strong> ChlorineC</li><li><strong>åˆ›å»ºäº:</strong> 2023-07-09 00:00:00</li><li><strong>æ›´æ–°äº:</strong> 2023-07-09 17:42:09</li><li><strong>é“¾æ¥:</strong> https://redefine.ohevan.com/posts/2808426581/</li><li><strong>ç‰ˆæƒå£°æ˜:</strong> æœ¬æ–‡ç« é‡‡ç”¨ <a class="license" target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh">CC BY-NC-SA 4.0</a> è¿›è¡Œè®¸å¯ã€‚</li></ul></div></div><ul class="post-tags-box"><li class="tag-item"><a href="/tags/websocket/">#websocket</a>&nbsp;</li></ul><div class="article-nav"><div class="article-prev"><a class="prev" rel="prev" href="/posts/768258525/"><span class="left arrow-icon flex-center"><i class="fa-solid fa-chevron-left"></i> </span><span class="title flex-center"><span class="post-nav-title-item">Python ç¼–ç¨‹ç¯å¢ƒé‡æ–°æ„å»º</span> <span class="post-nav-item">ä¸Šä¸€ç¯‡</span></span></a></div><div class="article-next"><a class="next" rel="next" href="/posts/3752592171/"><span class="title flex-center"><span class="post-nav-title-item">å‰ç«¯å·¥å…·é“¾ä¹‹åŒ…ç®¡ç†å™¨ - pnpm</span> <span class="post-nav-item">ä¸‹ä¸€ç¯‡</span> </span><span class="right arrow-icon flex-center"><i class="fa-solid fa-chevron-right"></i></span></a></div></div></div><div class="toc-content-container"><div class="post-toc-wrap"><div class="post-toc"><div class="toc-title">æ­¤é¡µç›®å½•</div><div class="page-title">WebSocket åº”ç”¨ç ”ç©¶</div><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%86%E8%A7%A3WebSocket%E5%8D%8F%E8%AE%AE"><span class="nav-text">äº†è§£WebSocketåè®®</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%80%9A%E4%BF%A1%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90"><span class="nav-text">é€šä¿¡åŸç†è§£æ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Node-js-%E5%AE%9E%E8%B7%B5"><span class="nav-text">Node.js å®è·µ</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#socket-io-%E5%BA%93"><span class="nav-text">socket.io åº“</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86"><span class="nav-text">å·¥ä½œåŸç†</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Node-js-%E5%AE%9E%E8%B7%B5-2"><span class="nav-text">Node.js å®è·µ</span></a></li></ol></li></ol></div></div></div></div></div></div></div><div class="main-content-footer"><footer class="footer"><div class="info-container"><div class="copyright-info">&copy; <span>2023</span> - 2023&nbsp;&nbsp;<i class="fa-solid fa-heart fa-beat" style="--fa-animation-duration:0.5s;color:#f54545"></i>&nbsp;&nbsp;<a href="/">ChlorineC</a></div><div class="theme-info info-item"><span class="powered-by-container">ç”± <?xml version="1.0" encoding="utf-8"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd"><svg version="1.1" id="åœ–å±¤_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="1rem" height="1rem" viewBox="0 0 512 512" enable-background="new 0 0 512 512" xml:space="preserve"><path fill="#0E83CD" d="M256.4,25.8l-200,115.5L56,371.5l199.6,114.7l200-115.5l0.4-230.2L256.4,25.8z M349,354.6l-18.4,10.7l-18.6-11V275H200v79.6l-18.4,10.7l-18.6-11v-197l18.5-10.6l18.5,10.8V237h112v-79.6l18.5-10.6l18.5,10.8V354.6z"/></svg><a target="_blank" href="https://hexo.io">Hexo</a> é©±åŠ¨</span><br><span class="theme-version-container">ä¸»é¢˜&nbsp;<a class="theme-version" target="_blank" href="https://github.com/EvanNotFound/hexo-theme-redefine">Redefine v2.2.1</a></span></div><div class="icp-info info-item"><a target="_blank" rel="nofollow" href="https://beian.miit.gov.cn">èœ€ICPå¤‡2022029268å·</a></div></div></footer></div></div><div class="post-tools"><div class="post-tools-container"><ul class="article-tools-list"><li class="right-bottom-tools page-aside-toggle"><i class="fa-regular fa-outdent"></i></li></ul></div></div><div class="right-side-tools-container"><div class="side-tools-container"><ul class="hidden-tools-list"><li class="right-bottom-tools tool-font-adjust-plus flex-center"><i class="fa-regular fa-magnifying-glass-plus"></i></li><li class="right-bottom-tools tool-font-adjust-minus flex-center"><i class="fa-regular fa-magnifying-glass-minus"></i></li><li class="right-bottom-tools tool-expand-width flex-center"><i class="fa-regular fa-expand"></i></li><li class="right-bottom-tools tool-dark-light-toggle flex-center"><i class="fa-regular fa-moon"></i></li><li class="right-bottom-tools tool-scroll-to-top flex-center"><i class="fa-regular fa-arrow-up"></i></li><li class="right-bottom-tools tool-scroll-to-bottom flex-center"><i class="fa-regular fa-arrow-down"></i></li></ul><ul class="visible-tools-list"><li class="right-bottom-tools toggle-tools-list flex-center"><i class="fa-regular fa-cog fa-spin"></i></li></ul></div></div><div class="image-viewer-container"><img src=""></div><div class="search-pop-overlay"><div class="popup search-popup"><div class="search-header"><span class="search-input-field-pre"><i class="fa-solid fa-keyboard"></i></span><div class="search-input-container"><input autocomplete="off" autocorrect="off" autocapitalize="off" placeholder="æœç´¢..." spellcheck="false" type="search" class="search-input"></div><span class="popup-btn-close"><i class="fa-solid fa-times"></i></span></div><div id="search-result"><div id="no-result"><i class="fa-solid fa-spinner fa-spin-pulse fa-5x fa-fw"></i></div></div></div></div></main><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/layouts/navbarShrink.js"></script><script src="/js/tools/scrollTopBottom.js"></script><script src="/js/tools/lightDarkSwitch.js"></script><script src="/js/tools/localSearch.js"></script><script src="/js/tools/codeBlock.js"></script><script src="/js/layouts/lazyload.js"></script><script src="/js/libs/Typed.min.js"></script><script src="/js/plugins/typed.js"></script><div class="post-scripts pjax"><script src="/js/tools/tocToggle.js"></script><script src="/js/libs/anime.min.js"></script><script src="/js/layouts/toc.js"></script><script src="/js/plugins/tabs.js"></script></div><script src="/js/libs/pjax.min.js"></script><script>window.addEventListener("DOMContentLoaded",()=>{window.pjax=new Pjax({selectors:["head title",".page-container",".pjax"],history:!0,debug:!1,cacheBust:!1,timeout:0,analytics:!1,currentUrlFullReload:!1,scrollRestoration:!1}),document.addEventListener("pjax:send",()=>{Global.utils.pjaxProgressBarStart()}),document.addEventListener("pjax:complete",()=>{Global.utils.pjaxProgressBarEnd(),window.pjax.executeScripts(document.querySelectorAll("script[data-pjax], .pjax script")),Global.refresh()})})</script></body></html>