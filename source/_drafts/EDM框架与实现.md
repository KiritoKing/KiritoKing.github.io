---
title: EDM框架与实现
tags:
---

在此前的[EDM与Table布局](#)一文中我提到了我在EDM编写过程中遇到的痛点，并提出了一套自己的EDM框架解决方案，这里我将详细地阐述这套框架的细节和记录实现过程，当做我前端工具链和编译系统的练手。

<!-- more -->

## 框架概述

*easy-edm* 框架是我的第一个前端工具链作品，**面向前端开发者而非低代码开发者**，致力于提高EDM-HTML的**可读性、可维护性和易用性**，实现对EDM的工程化管理。

同时，该框架也被设计为**渐进式**的，像Vue一样，开发者可以**先接入部分特性**，如先接入内联样式解析功能，但仍使用`<table>`编写，后面再逐渐形成组件化和系统化的CSS框架。

框架主要分为工具链和IDE两部分，还有二者结合的脚手架，提供完整的开发体验：

- EDM编译器及其工具链
  - **编译器**负责解析HTML语法树，生成`<table>`布局的HTML，并提供类似webpack的实时渲染的开发环境（dev-env）
  - **内联样式生成器（CSS解析器）**负责解析所有外部的CSS类，根据选择器优先级和组件树生成内联样式
  - **EDM-Lint**负责检查有无使用不兼容的语法，HTML有无语法错误等（配合Formatter使用）
  - 单元测试、兼容性测试、代码审查Hook等功能使用其他开源方案实现
- VSCode插件
  - 对接工具链功能，包括：实时渲染、代码检查和格式化
  - 代码提示（IntelliSense）

### 设计思路

由于EDM重在单页面效果呈现，不存在像Vue或React这样的数据流管理和数据绑定需求，面向EDM的框架更应注重**兼容性、样式管理和组件复用与微调**这三个方面，主要特点在于：

- 使用开发者熟悉的标签语法（如`<div>`）而尽量避免自创，降低上手成本

- **外联样式表、类选择器复用、组件复用**三大件保证了项目可维护性和可读性，提高了开发效率

- 编译器配合代码审查（工程化后更易实现审查和测试）保证了最终生成代码的一致性，最大程度地避免了代码冗余

#### 语法设计

> 由于*easy-edm* 的语法设计为**现代HTML5网页语法的子集+部分语法补充**的形式，直接使用HTML作为拓展名可能产生问题，因此将拓展名改为`.edm`，同时使用*easy-edm* 提供的编译器作HTML解析。

*easy-edm* 的语法主要设计思路是尽量提供原生HTML5开发体验，同时补充一些原生HTML没有的工程化功能（如组件引用）和语法糖（如快捷媒体查询）。

- 兼容大部分原生HTML组件，支持直接使用`<div>`而非`<td>`和`<tr>`进行设计，支持直接使用`flex`和`grid`进行布局，编译器会自动生成对应的`<table>`布局
  - 使用`row-flex`的`<div>`标签映射成一个`<tr>`标签，其`align`等属性也会对应映射为单元格属性
  - 使用`grid`实现的`<div>`标签映射成`<table>`和媒体查询的结合，自动生成不同场景下的表格，使用`display: none`切换
  - 普通流向的`<div>`则会被拆解成若干`<tr>`标签（最外层则会映射为`<table>`），直至显示元素本身被包裹在`<td>`标签中
  - `<section>`标签一定会被解析成新表；`<table>`标签仍可以正常使用
- 支持使用`<component src="..." />`来**在HTML中引入组件化开发的特性**，支持`style`内联样式和`class`类选择器，编译器会对其进行类似预处理器的文本替换，输出HTML时也会进行内联样式计算
- 支持使用`<responsive>`和`<breakpoint width="..px">`的**响应式语法糖**为无法共用一套代码的组件编写两套独立代码，行为与定义多个`<div>`和对应class，并用媒体查询控制`display`属性是一致的
  - `<responsive>`必须且只能接收至少一个`<breakpoint>`子标签，其他标签是非法的
  - 子标签`<breakpoint width="..px">`可以接收任何流元素，`width`属性留空则默认为0
  - 解析时按从小到大的顺序生成对应布局页面，如`[0, 375]`就会渲染两套界面，一套在`0<=width<375`的时候显示，另一套在`width>=375`的时候显示
- 支持在CSS中使用`@value val`直接**定义断点**，在`@media`和HTML中的`<breakpoint>`标签中（需使用`"{@val}"`语法来定义CSS寻址）均可使用，避免断点不统一生成多套`<table>`

#### 如何实现代码复用

看了上述语法设计其实应该已经大致明白这个框架如何通过复用和项目管理提高EDM开发的效率了，这里再系统地阐述一下如何使用 *easy-edm* 优化工作流程。

为了明白如何使用它来优化工作，我们要首先明白EDM编写流程有哪些痛点：

1. 大量的内联样式导致代码的**可读性和可维护性差**，还产生了大量**冗余样式**

2. 复制粘贴实现的代码复用导致**代码一致性差**，一个组件或样式出现问题后修改成本极高
3. 双端适配需要**编写大量重复代码**，挫败感强且浪费时间
4. 由于代码可维护性差，更**无法把控代码质量**导致恶性循环
5. **难以引入测试机制**，一旦出现兼容性问题很难定位

接下来，我们就针对这些痛点一一进行解决。

##### 样式复用

HTML作为标记语言，CSS作为样式表对其进行修饰，JS作为脚本管理HTML元素的行为，这是几十年来互联网发展史上已经形成的best-practice，在这方面我们无需再过多地进行构思，按照其设计的初衷行事即可。

页面上大多数组件的样式本就是重复的，两段文字只是因为DOM不同就要重新将内联样式抄一遍显然是不合理且不宜维护的。

编写EDM时我们也应该像其他的HTML一样简单地使用类选择器来管理页面中表现一致的组件样式。经过长期的发展（如果遵守合适的命名和组合规范的话），就可以形成一个专属的EDM样式库（或者称CSS框架），编写EDM的时间将大大缩短，而具体的兼容性问题则交给编译器就好。

##### 组件复用

在不同的EDM中可能会出现完全相同的组件反复被引用的情况，比起直接复制粘贴，更好的方法是像React、Vue这些工程化框架项目一样通过引用的方法管理和复用。一方面增加了CV键的寿命，一方面也方便在组件修改后全局生效。

需要注意的是，由于EDM是纯静态页面，因此不需要考虑复杂的状态，只需要像预处理器一样进行文本替换工作就可以实现组件化功能。

**组件复用和样式复用二者结合就可以减少EDM中至少80%的重复工作量。**

##### 代码生成与检查

直接编写几千行的HTML显然已经超出了普通人类对项目的管理能力，特别是在面对EDM这种短平快式的编写工作时，根本无暇顾及代码质量和一致性，在复用时也会产生麻烦。

如果工程化地编写HTML组件和页面，最后再编译成生产用EDM，其间省下的精力就可以让人更关心代码质量（如类的复用规则和组件抽象），更简洁的语法也有利于引入项目的代码检查和系统测试。

最重要的一点是，人的行为是不可控的，但编译器的行为是可控的，只要满足简单的编码规范和语法，**编译器生成的代码一定是一致的、无冗余的**，这对最终结果的稳定也大有裨益。

##### 系统测试

通过接入第三方开源的测试方案，我们可以对HTML的功能进行全面的测试，也可以对最终成品进行兼容性测试。

由于工程化管理，我们也可以对每次Commit的代码进行质量检查。

##### 启动成本

传统的EDM若没有现有项目参考很难快速上手，本框架提供了开箱即用的脚手架，可以使用传统的HTML开发方式快速生成EDM，并快速积累组件库和样式库，适合迅捷开发模式。



---

## 实现过程与机制

### Ⅰ 市场调研

由于以前试图造轮子的悲惨经历，这次我选择先在Github上调研一下类似的项目
