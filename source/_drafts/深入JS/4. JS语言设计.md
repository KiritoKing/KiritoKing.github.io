---
title: 深入JS - 4.JavaScript语言设计
excerpt: 这篇文章主要讨论JavaScript中一些特殊的语言特性（如原型链、`this`指针等），它们为什么要被设计成这样（JS的语言历史），在现代JS开发中要如何看待这些特性，以及ES6标准和TypeScript对JavaScript生态带来了什么影响。
tags:
  - 语言特性
  - javascript
  - typescript
  - es6
  - webassembly
---

JavaScript无疑是一门非常容易上手的语言，如果仅仅是要快速地写一个程序，只要你有任何编程基础，你甚至不用系统学习JavaScript的任何语法，和Python一样，直接上手调试就能写出可以运行的代码。

但在前端逐渐泛化的今天，如果你要使用JavaScript维护一个大项目，不同功能之间复杂的相互引用（上下文）和逻辑本身的数据流复杂性（继承链）等就不可避免地会涉及到JavaScript的语言特性和设计细节，来保持整个项目的一致性和可维护性。除此之外，还有更多的现代特性或者引入TypeScript的类型特性，这又引入了更多问题：

- ES6标准是如何实现的？新标准的实现和旧体系有什么本质区别吗，还是只是语法糖？
- 什么时候引入TypeScript，完全使用TS重构还是只使用类型声明（`.d.ts`）？
- TypeScript的类型体系为什么要这么设计，又是怎么实现静态类型检查的？

为了解决上面这些问题，我们从JavaScript本身入手，从历史渊源和设计思路出发，理清其发展逻辑。不仅讨论JavaScript中一些**特殊的语言特性**（如原型链、`this`指针等），还要讨论它们**为什么要被设计成这样**，在现代JS开发中要如何看待这些特性。在此基础上吗，我们还要深入理解**ES6标准和TypeScript**，为什么要这么设计，以及对JavaScript生态带来了什么影响。

最后，透过JavaScript，我们还要看到Web前端开发未来的风向，如*WebAssembly*这样的“新”技术。

## 古典 JavaScript

> **如果你是初学JavaScript，请不要参照此文章**，而是直接寻找一篇*现代JavaScript教程*，边做边学。以下这些概念可能会误导你了解一些老旧的开发思想和编程范式，不利于快速掌握现代JS开发。
>
> 更好的选择是，**你已经学会使用JS开发一些项目后，再回过头来研究JS的语言细节。**

有些JS特性和设计真的是典中之典，像什么原型链、`this`指向、闭包和词法作用域等等，不一而绝，折磨了一代又一代前端面试者。他们的存在有他们的意义，也有很大的时代局限性，可预见的这些老旧的特性在新时代将逐渐被边缘化，但理解它们则有利于我们理解JavaScript这门语言的本质和设计思路。

因此，我们不应像其他面向面试的文章一样只知道它怎么用，怎么考，更要知道当初Brendan Eich（JavaScript之父~~万恶之源~~）**为什么要这样设计它**，这就脱离了应试的范畴，可以锻炼我们对语言特性的理解能力和语言设计能力。



其实，JavaScript的很多奇怪的早期特性，都和它早期的设计原则有很大关系：

- JavaScript是一个**弱类型的动态脚本语言**
- JavaScript应写起来尽量像Java，但**面向对象而不是面向类**（最终实现起来变成了扭曲的**面向原型**）
- JavaScript中**没有class**，**一切皆对象，函数（function）是一等公民**，是特殊的对象

### 数据类型

JavaScript中共有8种数据类型：7种原始类型和1种引用类型（`Object`）。和Java语言一样，原始类型直接存储在栈（stack）中，引用类型在堆中分配空间，通过指针调用，并由GC管理生命周期。

#### 对象类型

这是整个JavaScript中最重要的部分，甚至没有之一！

JavaScript是一门面向**对象**的语言！是的，不是面向类！如果不理解对象是如何定义、存储和调用的，那么后面的内容包括原型、this的实际指向等等内容都将无从谈起。

首先我们要确定一个原则，请把它牢牢记在心里：

>  在JavaScript中，一切皆对象。

##### 对象的本质

对象实际上是一个**引用类型**，也就是一个**指针**，它指向堆空间中的一个区域，而这个区域的存储结构是**键值对（key-value pair）**。

![image-20230505143033685](https://picgo-1308055782.cos.ap-chengdu.myqcloud.com/picgo-new/202305051433184.png)

在其他语言中，基于Hash表的字典（dict）或者说`HashMap`往往具有比较特殊的地位，因为它提供了一种近似花费`O(1)`（忽略冲突）时间就能对键值对寻址的方法；在JavaScript中，它就是对象`Object`。JavaScript中原生是没有`Map`的（最开始的时候），因为`Object`中就提供了类似的功能，这是一种激进的解决方案。

##### 数组（`Array`）

数组（`Array`）或者说其他任何容器类型都是**特殊的对象**，但数组一定是最常用的一个。数组包装了有序同类型数据集合所需要的方法，其内部实现（至少在语法上）仍是对象。

- 数组可以当作队列/栈来使用，也可以当作普通的连续表按下标访问：`push`在末尾插入一个元素，`pop`在末尾弹出一个元素，`shift`在开头弹出一个元素，`unshift`在开头插入一个元素
- 数组在语法上是把数字（`number`）当作对象的键，以及提供了一些拓展方法（如`length`属性）
- 在底层中，数组与普通对象却不尽相同，JS解释器会和其他语言中的变长列表一样，为数组分配一段连续的空间，查找时间也尽量满足`O(1)`

##### `Map`和`Set`

`Map`和`Set`是ES6新引入的集合数据类型，应着重关注它们都作为键值对集合，彼此以及与`Object`的区别。

这里先不详细叙述，详见**ES6部分**。

#### 原始类型

7大原始类型和其他语言（如Java）类似，其中最经典的有：`string`，`number`，`boolean`，`null` 和 `undefined`。

>  由于`bigint`和`symbol`是ES6中新增的类型，这里先按下不表，这里只讨论古典类型，待到ES6的部分再详细讨论。

然而，原始类型虽然直接存储数值，但 JavaScript 仍允许我们像使用对象一样使用原始类型（字符串，数字等）。JS不仅提供了自动装箱、拆箱的操作（Just like Java），还为其提供了一系列拓展方法（如`string.indexOf()`）。

- `number` 类型中常规数字以 64 位的格式 [IEEE-754](https://en.wikipedia.org/wiki/IEEE_754) 存储，也被称为“双精度浮点数”。这是我们大多数时候所使用的数字；
- `string` 类型的内部格式始终是 [UTF-16](https://en.wikipedia.org/wiki/UTF-16)，它不依赖于页面编码
- `null` 和 `undefined` 是特殊的基本类型，它们没有任何拓展方法（在TypeScript中将更深入了解它们的类型关系）
  - `null` 相当于一个卷纸盒里没有卷纸的情况，至少这里还有一个卷纸盒（声明了一个变量，且赋予了null初值）
  - `undefined` 相当于连卷纸盒都没有的情况（声明了变量，但并没有初始化）

### 动态特性与词法作用域





### 基于原型（prototype）的继承

虽然JavaScript是一门面向对象的语言，但却没有任何关于类（class）的概念，在提到继承时，所有概念都会回到一个叫“原型”（prototype）的概念上。



### `this` 究竟指向哪里

其实如果仅仅是要正确使用`this`和知道它指向哪里还是很简单的，首先需要明确2个原则：

- `this`永远指向一个`Object`
- `this`的指向取决于**函数**被调用的位置

一个经典的例子：

```javascript
var obj = {
  foo: function () { console.log(this.bar) },
  bar: 1
};

var foo = obj.foo;
var bar = 2;

obj.foo() // 1
foo() // 2
```

简单地说，`this`指的是函数运行时所处的环境，对于`obj.foo()`来说，`foo`运行在`obj`环境，所以`this`指向`obj`；对于`foo()`来说，`foo`运行在全局环境，所以`this`指向全局环境。所以，两者的运行结果不一样。

#### 为什么会产生不同的指向



### 闭包（closure）和作用域



## 现代 JavaScript



## JavaScript 的未来



## 参考资料

- [JavaScript 二十年 (history.js.org)](https://cn.history.js.org/)
- [JavaScript 编程精解 中文第三版 · JavaScript 编程精解 中文第三版 (gitbooks.io)](https://wizardforcel.gitbooks.io/eloquent-js-3e/content/)
- [如何循序渐进、有效地学习JavaScript？ - 知乎 (zhihu.com)](https://www.zhihu.com/question/19713563)

- [现代 JavaScript 教程](https://zh.javascript.info/)

- [JavaScript - 学习 Web 开发 | MDN (mozilla.org)](https://developer.mozilla.org/zh-CN/docs/Learn/JavaScript)

- [是什么原因导致了 JS 中的 this 指向问题？ - 知乎 (zhihu.com)](https://www.zhihu.com/question/412637481/answer/1539325572)
